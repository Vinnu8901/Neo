
/* offlineXpath.js — merged robust build
   Version: adhy-offline-rebuild-2025-09
*/
window.AdhyPatch = window.AdhyPatch || {};
const NS = window.AdhyPatch;

// -------------------- Phase 1: State --------------------
NS.version = NS.version || 'adhy-offline-2025';
NS.CURRENT_HTML = NS.CURRENT_HTML || '';
NS.CURRENT_LOCATORS = NS.CURRENT_LOCATORS || [];
NS.CURRENT_LOCATORS_SINGLE = NS.CURRENT_LOCATORS_SINGLE || null;
NS.CUSTOM_LOCATORS = NS.CUSTOM_LOCATORS || [];
NS.PARSER_DOC = window._PARSER_DOC || null;

// -------------------- Phase 2: Utilities --------------------
(function(){
  NS.$ = NS.$ || ((sel, root=document) => { try { return (root||document).querySelector(sel); } catch(e){ return null; }});
  NS.$$ = NS.$$ || ((sel, root=document) => { try { return Array.from((root||document).querySelectorAll(sel)); } catch(e){ return []; }});

  NS.showToast = NS.showToast || function(msg, type='info'){
    try {
      let t = document.getElementById('__adhy_toast');
      if(!t){
        t = document.createElement('div');
        t.id = '__adhy_toast';
        t.style.cssText = 'position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.78);color:#fff;z-index:2147483647;font-family:system-ui,Arial;transition:opacity .18s';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.background = (type==='error')? '#b91c1c' : (type==='success')? '#047857' : 'rgba(0,0,0,0.78)';
      t.style.opacity = '1';
      clearTimeout(t._t);
      t._t = setTimeout(()=>{ try { t.style.opacity = '0'; } catch(e){} }, 1800);
    } catch(e){ console.log(msg); }
  };

  NS.copyToClipboard = NS.copyToClipboard || async function(text){
    try {
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        NS.showToast('Copied', 'success');
        return true;
      }
    } catch(e){}
    try {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.select();
      document.execCommand && document.execCommand('copy');
      document.body.removeChild(ta);
      NS.showToast('Copied (fallback)', 'success');
      return true;
    } catch(err){
      NS.showToast('Copy failed', 'error');
      return false;
    }
  };

  NS.escapeHtml = NS.escapeHtml || function(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };

  NS.xpathLiteral = NS.xpathLiteral || function(s){
    s = String(s||'');
    if(s.indexOf('"') === -1) return `"${s}"`;
    if(s.indexOf("'") === -1) return `'${s}'`;
    const parts = s.split('"'), out=[];
    for(let i=0;i<parts.length;i++){
      if(parts[i] !== '') out.push(`"${parts[i].replace(/\\/g,'\\\\')}"`);
      if(i < parts.length-1) out.push(`'"'`);
    }
    return `concat(${out.join(',')})`;
  };

  NS.cssSelectorFor = NS.cssSelectorFor || function(el){
    if(!el || !el.tagName) return '';
    if(el.id) try { return `#${CSS.escape(el.id)}`; } catch(e) { return '#'+el.id; }
    let sel = el.tagName.toLowerCase();
    try {
      if(el.classList && el.classList.length) sel += '.' + Array.from(el.classList).slice(0,3).map(c=>c.replace(/\s+/g,'')).join('.');
      const name = el.getAttribute && el.getAttribute('name');
      if(name) sel += `[name="${name}"]`;
    } catch(e){}
    return sel;
  };
})();

// -------------------- Phase 3: Preview access --------------------
(function(){
  const PREVIEW_SELECTORS = ['#preview','iframe#preview','.preview','iframe.preview'];
  function getPreviewElement(){
    for(const s of PREVIEW_SELECTORS){
      try { const el = document.querySelector(s); if(el) return el; } catch(e){}
    }
    try { return document.querySelector('iframe'); } catch(e){ return null; }
  }
  function getPreviewDocument(){
    const el = getPreviewElement();
    if(!el) return window._PARSER_DOC || document;
    if(el.tagName && el.tagName.toLowerCase() === 'iframe'){
      try { if(el.contentDocument) return el.contentDocument; } catch(e){}
      if(el.srcdoc) try { return (new DOMParser()).parseFromString(el.srcdoc,'text/html'); } catch(e){}
    }
    return window._PARSER_DOC || document;
  }
  NS.getPreviewElement = getPreviewElement;
  NS.getPreviewDocument = getPreviewDocument;
})();

// -------------------- Phase 4: Iframe/Shadow traversal + highlight --------------------
(function(){
  function evaluateXPath(doc, xpath){
    try { return doc.evaluate(xpath, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue; } catch(e){ return null; }
  }
  function findInShadowRoots(xpath, root){
    try {
      const direct = evaluateXPath(root, xpath);
      if(direct) return direct;
    } catch(e){}
    try {
      const walker = root.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null, false);
      let node = walker.nextNode();
      while(node){
        if(node.shadowRoot){
          const found = findInShadowRoots(xpath, node.shadowRoot);
          if(found) return found;
        }
        node = walker.nextNode();
      }
    } catch(e){}
    return null;
  }
  function findInIframes(xpath, win){
    win = win || window;
    try {
      const doc = win.document;
      const d = evaluateXPath(doc, xpath);
      if(d) return { el:d, win };
      const s = findInShadowRoots(xpath, doc);
      if(s) return { el:s, win };
      const frames = doc.querySelectorAll ? Array.from(doc.querySelectorAll('iframe,frame')) : [];
      for(let i=0;i<frames.length;i++){
        const fr = frames[i];
        try {
          if(!fr.contentWindow) continue;
          const res = findInIframes(xpath, fr.contentWindow);
          if(res && res.el) return res;
        } catch(e){ }
      }
    } catch(e){}
    return null;
  }
  function transientHighlightElement(el, opts){
    if(!el || !el.style) return;
    opts = opts || {};
    const color = opts.color || 'rgba(124,92,255,0.45)';
    const orig = { outline: el.style.outline||'', boxShadow: el.style.boxShadow||'', zIndex: el.style.zIndex||'' };
    try { el.style.outline = `3px solid ${color}`; el.style.boxShadow = `0 0 0 4px ${color}`; el.style.zIndex = 2147483647; el.scrollIntoView({behavior:'auto', block:'center'}); } catch(e){}
    setTimeout(()=>{ try { el.style.outline = orig.outline; el.style.boxShadow = orig.boxShadow; el.style.zIndex = orig.zIndex; } catch(e){} }, opts.duration || 1600);
  }

  NS.findInIframes = findInIframes;
  NS.transientHighlightElement = transientHighlightElement;

  NS.tryHighlightByXPath = function(xpath){
    if(!xpath) return false;
    try {
      const docFound = evaluateXPath(document, xpath);
      if(docFound){ transientHighlightElement(docFound, {color:'rgba(255,165,0,0.6)'}); return true; }
    } catch(e){}
    try {
      const previewEl = NS.getPreviewElement && NS.getPreviewElement();
      if(previewEl && previewEl.tagName && previewEl.tagName.toLowerCase()==='iframe'){
        try {
          const pd = previewEl.contentDocument;
          if(pd){
            const pfound = evaluateXPath(pd, xpath) || findInShadowRoots(xpath, pd);
            if(pfound){ transientHighlightElement(pfound, {color:'rgba(0,150,255,0.45)'}); return true; }
          }
        } catch(err){}
      }
    } catch(e){}
    try {
      const res = findInIframes(xpath, window);
      if(res && res.el){ transientHighlightElement(res.el, {color:'rgba(0,150,255,0.45)'}); return true; }
    } catch(e){}
    return false;
  };
})();

// -------------------- Phase 5: Locator strategies --------------------
(function(){
  function safeAttr(el, name){ try { return el.getAttribute ? el.getAttribute(name) : null; } catch(e){ return null; } }
  function getLabelFor(el){
    try {
      if(!el) return '';
      if(el.id){
        try { const l = document.querySelector && document.querySelector(`label[for="${el.id}"]`); if(l && l.textContent) return l.textContent.trim(); } catch(e){}
      }
      if(el.closest){
        const pl = el.closest('label'); if(pl && pl.textContent) return pl.textContent.trim();
      }
      const txt = (el.innerText || el.textContent || '').trim();
      if(txt) return txt.slice(0,160);
      const ph = safeAttr(el,'placeholder'); if(ph) return ph;
      return '';
    } catch(e){ return ''; }
  }

  function genBasicXPath(el){
    if(!el) return '';
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const tag = el.tagName.toLowerCase();
    const name = safeAttr(el,'name');
    if(name) return `//${tag}[@name=${NS.xpathLiteral(name)}]`;
    const label = getLabelFor(el);
    if(label) return `//${tag}[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    // fallback relative absolute (limited depth)
    const parts = []; let cur = el; let depth=0;
    while(cur && cur.nodeType===1 && depth<8){
      const t = cur.tagName.toLowerCase();
      let ix = 1; let sib = cur.previousElementSibling;
      while(sib){ if(sib.tagName === cur.tagName) ix++; sib = sib.previousElementSibling; }
      parts.unshift(`${t}${ix>1?`[${ix}]`:''}`);
      cur = cur.parentElement; depth++;
    }
    return '//' + parts.join('/');
  }

  function genWildcardXPath(el){
    if(!el) return genBasicXPath(el);
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const label = getLabelFor(el);
    if(label) return `//*[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    const name = safeAttr(el,'name'); if(name) return `//*[contains(@name, ${NS.xpathLiteral(name)})]`;
    const cls = (safeAttr(el,'class')||'').split(/\s+/).filter(Boolean)[0];
    if(cls) return `//*[contains(concat(' ', normalize-space(@class), ' '), ${NS.xpathLiteral(' '+cls+' ')})]`;
    return genBasicXPath(el);
  }

  function genAxesXPath(el){
    if(!el) return genBasicXPath(el);
    const tag = el.tagName.toLowerCase();
    if(el.id) return `//label[@for=${NS.xpathLiteral(el.id)}]/following::${tag}[1]`;
    const label = getLabelFor(el);
    if(label) return `//label[contains(normalize-space(.), ${NS.xpathLiteral(label)})]/following::${tag}[1]`;
    return genBasicXPath(el);
  }

  function genFunctionXPath(el){
    if(!el) return genBasicXPath(el);
    const tag = el.tagName.toLowerCase();
    const ph = safeAttr(el,'placeholder'); if(ph) return `//${tag}[contains(@placeholder, ${NS.xpathLiteral(ph)})]`;
    const ti = safeAttr(el,'title'); if(ti) return `//${tag}[contains(@title, ${NS.xpathLiteral(ti)})]`;
    const aria = safeAttr(el,'aria-label'); if(aria) return `//${tag}[@aria-label=${NS.xpathLiteral(aria)}]`;
    return genBasicXPath(el);
  }

  function genSalesforceXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if(safeAttr(el,'data-qa-locator')) return `//${tag}[@data-qa-locator=${NS.xpathLiteral(safeAttr(el,'data-qa-locator'))}]`;
    if(safeAttr(el,'data-id')) return `//${tag}[@data-id=${NS.xpathLiteral(safeAttr(el,'data-id'))}]`;
    return '';
  }

  function genPegaXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if(safeAttr(el,'data-test-id')) return `//${tag}[@data-test-id=${NS.xpathLiteral(safeAttr(el,'data-test-id'))}]`;
    if(safeAttr(el,'data-ctl')) return `//${tag}[@data-ctl=${NS.xpathLiteral(safeAttr(el,'data-ctl'))}]`;
    return '';
  }

  NS.genBasicXPath = genBasicXPath;
  NS.genWildcardXPath = genWildcardXPath;
  NS.genAxesXPath = genAxesXPath;
  NS.genFunctionXPath = genFunctionXPath;
  NS.genSalesforceXPath = genSalesforceXPath;
  NS.genPegaXPath = genPegaXPath;

  NS.generateLocatorsForElement = function(el){
    if(!el) return null;
    const loc = {
      tag: el.tagName.toLowerCase(),
      id: el.id || '',
      text: getLabelFor(el) || '',
      xpaths: {
        basic: genBasicXPath(el),
        wildcards: genWildcardXPath(el),
        axes: genAxesXPath(el),
        functions: genFunctionXPath(el),
        salesforce: genSalesforceXPath(el),
        pega: genPegaXPath(el)
      },
      css: NS.cssSelectorFor(el),
      _ref: el
    };
    return loc;
  };
})();

// -------------------- Phase 6: Collect & fill list --------------------
(function(){
  function shouldSkip(el){
    try {
      if(!el || el.nodeType !== 1) return true;
      if(el.hasAttribute && el.hasAttribute('hidden')) return true;
      const s = (el.getAttribute && el.getAttribute('style')||'').toLowerCase();
      if(s && (/display\s*:\s*none|visibility\s*:\s*hidden/).test(s)) return true;
      if(el.tagName && el.tagName.toLowerCase()==='script') return true;
      if(el.tagName && el.tagName.toLowerCase()==='a' && (!el.hasAttribute('href') || el.getAttribute('href') === '#')) return true;
    } catch(e){ return true; }
    return false;
  }
  function collectCandidateElements(doc){
    doc = doc || NS.getPreviewDocument();
    const selectors = ['input:not([type="hidden"])','button','a','select','textarea','[role="button"]','[data-qa-locator]','[data-test-id]','[data-ctl]','lightning-input','lightning-button'];
    let els = [];
    try { els = Array.from(doc.querySelectorAll(selectors.join(','))); } catch(e){ els = []; }
    els = els.filter(e => !shouldSkip(e));
    // dedupe by signature
    const seen = new Set(); const out = [];
    els.forEach(el=>{
      try {
        const sig = [el.tagName.toLowerCase(), el.id||'', el.getAttribute && el.getAttribute('name')||'', (el.textContent||'').trim().slice(0,60)].join('|');
        if(seen.has(sig)) return;
        seen.add(sig); out.push(el);
      } catch(e){}
    });
    return out;
  }

  NS.extractAllLocators = function(opts){
    opts = opts || {};
    const doc = NS.getPreviewDocument();
    const elements = collectCandidateElements(doc);
    NS.CURRENT_LOCATORS = elements.map((el, idx) => { const r = NS.generateLocatorsForElement(el); r._index = idx; r._id = r.id || `E${idx+1}`; return r; });
    try { NS.fillLocatorList && NS.fillLocatorList(NS._activePanel || 'basic'); } catch(e){}
    NS.showToast(`Extracted ${NS.CURRENT_LOCATORS.length} elements`);
    return NS.CURRENT_LOCATORS;
  };

  // core: renders rows with checkbox, aligned using flex
  NS.fillLocatorList = function(panel='basic'){
    panel = panel || 'basic';
    NS._activePanel = panel;
    const container = NS.$('#locator-list');
    if(!container){ console.warn('locator-list missing'); return; }
    container.innerHTML = '';
    // toolbar area we keep separate, but list will show rows
    const list = document.createElement('div'); list.id = 'locListRows'; list.className = 'list'; list.style.padding = '6px'; list.style.marginTop = '6px';
    const data = NS.CURRENT_LOCATORS || [];
    if(!data.length){
      const empty = document.createElement('div'); empty.className='small'; empty.textContent = 'No locators. Render and extract first.';
      container.appendChild(empty); return;
    }
    data.forEach((it, idx)=>{
      const val = (it.xpaths && it.xpaths[panel]) || it.css || '';
      const row = document.createElement('div'); row.className='loc-row'; row.style.display = 'flex'; row.style.alignItems='center'; row.style.gap='10px';
      row.style.padding = '8px'; row.style.borderRadius = '8px'; row.style.justifyContent = 'space-between';
      // left: checkbox + badge + label
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px'; left.style.flex='1'; left.style.minWidth='0';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='loc-check'; cb.dataset.idx = idx;
      const badge = document.createElement('span'); badge.className='badge'; badge.textContent = it.tag || 'el';
      const meta = document.createElement('div'); meta.style.minWidth='0';
      meta.innerHTML = `<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${NS.escapeHtml(it.text||'(no text)')}</div><div class="small" style="color:#6b7280">${NS.escapeHtml(it._id||'')}</div>`;
      left.appendChild(cb); left.appendChild(badge); left.appendChild(meta);
      // mid: value (mono)
      const mid = document.createElement('div'); mid.className='mono'; mid.style.flex='2'; mid.style.whiteSpace='nowrap'; mid.style.overflow='hidden'; mid.style.textOverflow='ellipsis'; mid.textContent = val;
      // actions
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
      const btnCopy = document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Copy'; btnCopy.style.padding='6px 8px';
      const btnHi = document.createElement('button'); btnHi.className='btn'; btnHi.textContent='Highlight'; btnHi.style.padding='6px 8px';
      actions.appendChild(btnCopy); actions.appendChild(btnHi);
      // row click: copy & highlight (unless target is button or checkbox)
      row.addEventListener('click', async (e)=>{
        if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON')) return;
        if(!val){ NS.showToast('No locator', 'error'); return; }
        NS.tryHighlightByXPath(val);
        await NS.copyToClipboard(val);
        NS.showToast('Copied & highlighted', 'success');
      });
      // button handlers
      btnCopy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(!val) return; await NS.copyToClipboard(val); });
      btnHi.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!val) return NS.tryHighlightByXPath(val); });

      // assemble
      row.appendChild(left); row.appendChild(mid); row.appendChild(actions);
      list.appendChild(row);
    });
    container.appendChild(list);
    // update toolbar count
    const countSpan = NS.$('#loc-count');
    if(countSpan) countSpan.textContent = `${data.length} locators`;
  };
})();

// -------------------- Phase 7: Custom interactive capture --------------------
(function(){
  // when user clicks inside preview, capture that element, build locators, show in custom
  function interactiveClickHandler(e){
    try {
      e.preventDefault && e.preventDefault();
      e.stopPropagation && e.stopPropagation();
      const el = e.target;
      if(!el) return;
      const loc = NS.generateLocatorsForElement(el);
      if(!loc) return;
      NS.CURRENT_LOCATORS_SINGLE = loc;
      // Put the single locators into CUSTOM_LOCATORS (as single item)
      NS.CUSTOM_LOCATORS = [loc];
      // Switch UI to custom panel: highlight the chip if present
      const customChip = Array.from(document.querySelectorAll('.chip')).find(c=>c.dataset.paneltab === 'custom');
      if(customChip){
        document.querySelectorAll('.chip').forEach(cc=>cc.classList.remove('active'));
        customChip.classList.add('active');
      }
      renderCustomLocators(loc);
      // auto-select the created rows (if any)
      setTimeout(()=> {
        Array.from(document.querySelectorAll('#locator-list .loc-row input.loc-check')).forEach(cb => cb.checked = true);
      }, 50);
      // add snippet to output
      const out = NS.$('#output');
      if(out) out.value = (out.value ? out.value + '\n\n' : '') + buildSnippetForElement(loc);
      NS.showToast('Captured element — shown under Custom', 'success');
    } catch(err){ console.error('capture fail', err); NS.showToast('Capture failed', 'error'); }
  }

  function renderCustomLocators(loc){
    const container = NS.$('#locator-list');
    if(!container) return;
    container.innerHTML = '';
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='8px';
    const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:800">${NS.escapeHtml(loc.text||loc.tag)}</div><div class="small" style="color:#9aa4b2">${NS.escapeHtml(loc.id||'')}</div>`;
    wrap.appendChild(title);
    // create rows with checkbox for each strategy
    const strategies = ['basic','wildcards','axes','functions','salesforce','pega'];
    strategies.forEach(k=>{
      const v = (loc.xpaths && loc.xpaths[k]) || '';
      const row = document.createElement('div'); row.className='loc-row'; row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.className='loc-check';
      const lbl = document.createElement('div'); lbl.style.width='120px'; lbl.style.fontWeight='700'; lbl.textContent = k.toUpperCase();
      const valDiv = document.createElement('div'); valDiv.className='mono'; valDiv.style.flex='1'; valDiv.style.wordBreak='break-word'; valDiv.textContent = v || '(none)';
      const copy = document.createElement('button'); copy.className='btn'; copy.textContent='Copy'; copy.style.padding='6px';
      const hi = document.createElement('button'); hi.className='btn'; hi.textContent='Highlight'; hi.style.padding='6px';
      copy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(!v) return; await NS.copyToClipboard(v); });
      hi.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!v) return NS.tryHighlightByXPath(v); });
      row.appendChild(cb); row.appendChild(lbl); row.appendChild(valDiv); row.appendChild(copy); row.appendChild(hi);
      wrap.appendChild(row);
    });
    // CSS row
    const cssRow = document.createElement('div'); cssRow.className='loc-row'; cssRow.style.display='flex'; cssRow.style.alignItems='center'; cssRow.style.gap='10px';
    const cssCb = document.createElement('input'); cssCb.type='checkbox'; cssCb.className='loc-check';
    const cssLbl = document.createElement('div'); cssLbl.style.width='120px'; cssLbl.style.fontWeight='700'; cssLbl.textContent = 'CSS';
    const cssVal = document.createElement('div'); cssVal.className='mono'; cssVal.style.flex='1'; cssVal.style.wordBreak='break-word'; cssVal.textContent = loc.css || '(none)';
    const cssCopy = document.createElement('button'); cssCopy.className='btn'; cssCopy.textContent='Copy'; cssCopy.style.padding='6px';
    cssCopy.addEventListener('click', async ()=>{ await NS.copyToClipboard(loc.css||''); });
    cssRow.appendChild(cssCb); cssRow.appendChild(cssLbl); cssRow.appendChild(cssVal); cssRow.appendChild(cssCopy);
    wrap.appendChild(cssRow);

    container.appendChild(wrap);
    // update loc-count
    const countSpan = NS.$('#loc-count');
    if(countSpan) countSpan.textContent = 'Custom (1)';
  }

  function buildSnippetForElement(loc){
    const name = (loc.text || loc.tag || 'elem').replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40) || 'elem';
    const xp = loc.xpaths && (loc.xpaths.basic || loc.xpaths.wildcards || loc.xpaths.axes) || '';
    const css = loc.css || '';
    const code = [
      `// name=${name}`,
      `// XPath: ${xp}`,
      `// CSS: ${css}`,
      `// Selenium (Java): @FindBy(xpath="${xp.replace(/"/g,'\\"')}") WebElement ${name};`,
      `// Playwright (JS): await page.locator('xpath=${xp}').click();`
    ].join('\n');
    return code;
  }

  NS.attachHandlersToPreview = function(){
    try {
      NS.detachAllPreviewHandlers && NS.detachAllPreviewHandlers();
    } catch(e){}
    try {
      const previewEl = NS.getPreviewElement && NS.getPreviewElement();
      if(previewEl && previewEl.tagName && previewEl.tagName.toLowerCase()==='iframe'){
        const attach = (pd) => {
          try {
            if(!pd) return;
            // ensure previous click handlers removed by detachAllPreviewHandlers usage
            pd.addEventListener('click', interactiveClickHandler, true);
            NS.attachPreviewHandler && NS.attachPreviewHandler(pd, 'click', interactiveClickHandler);
          } catch(e){ console.warn('attach fail', e); }
        };
        try {
          if(previewEl.contentDocument && (previewEl.contentDocument.readyState==='complete' || previewEl.contentDocument.readyState==='interactive')){
            attach(previewEl.contentDocument);
          } else {
            previewEl.addEventListener('load', ()=>{ try{ attach(previewEl.contentDocument); } catch(e){} }, {once:true});
          }
        } catch(e){}
      } else {
        // inline preview (fallback) - attach to parser doc if present
        try {
          const pd = window._PARSER_DOC || document;
          pd.addEventListener && pd.addEventListener('click', interactiveClickHandler, true);
          NS.attachPreviewHandler && NS.attachPreviewHandler(pd, 'click', interactiveClickHandler);
        } catch(e){}
      }
    } catch(e){ console.warn(e); }
  };

  NS.detachAllPreviewHandlers = function(){
    try {
      (window._AdhyanPreviewListeners || []).forEach(o=>{
        try { o.doc.removeEventListener(o.type, o.handler, true); } catch(e){}
      });
      window._AdhyanPreviewListeners = [];
    } catch(e){}
  };

  NS.attachHandlersToPreview = NS.attachHandlersToPreview.bind(NS);
})();

// -------------------- Phase 8: UI wiring (toolbar + buttons) --------------------
(function(){
  // wire select all checkbox
  function wireToolbar(){
    const selAll = NS.$('#loc-sel-all');
    if(selAll){
      selAll.addEventListener('change', ()=> {
        const checks = Array.from(document.querySelectorAll('#locator-list .loc-check'));
        checks.forEach(cb=> cb.checked = !!selAll.checked);
      });
    }
    // Copy selected
    document.getElementById('loc-copy')?.addEventListener('click', async ()=>{
      const vals = Array.from(document.querySelectorAll('#locator-list .loc-check:checked')).map(cb=>{
        const row = cb.closest('.loc-row');
        if(!row) return '';
        const mono = row.querySelector('.mono');
        return mono ? mono.textContent.trim() : '';
      }).filter(Boolean);
      if(!vals.length){ NS.showToast('No rows selected', 'error'); return; }
      await NS.copyToClipboard(vals.join('\n'));
      NS.showToast('Selected copied', 'success');
    });
    // Download selected
    document.getElementById('loc-download')?.addEventListener('click', ()=>{
      const vals = Array.from(document.querySelectorAll('#locator-list .loc-check:checked')).map(cb=>{
        const row = cb.closest('.loc-row');
        if(!row) return '';
        const mono = row.querySelector('.mono');
        return mono ? mono.textContent.trim() : '';
      }).filter(Boolean);
      if(!vals.length){ NS.showToast('No rows selected', 'error'); return; }
      const blob = new Blob([vals.join('\n')], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'selected-locators.txt'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
      NS.showToast('Download started', 'success');
    });
  }

  // wire chip panel switching (basic, wildcards, ... custom)
  function wirePanelTabs(){
    const chips = Array.from(document.querySelectorAll('.chip'));
    chips.forEach(ch => ch.addEventListener('click', ()=>{
      chips.forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      const panel = ch.dataset.paneltab || 'basic';
      if(panel === 'custom' && NS.CURRENT_LOCATORS_SINGLE){
        // render custom for last captured element
        renderCustomIfSingle();
      } else {
        NS.fillLocatorList && NS.fillLocatorList(panel);
      }
    }));
  }

  function renderCustomIfSingle(){
    if(!NS.CURRENT_LOCATORS_SINGLE) return NS.fillLocatorList && NS.fillLocatorList('basic');
    // prefer to use the existing showCustomLocators if present
    if(typeof NS.showCustomLocators === 'function') return NS.showCustomLocators(NS.CURRENT_LOCATORS_SINGLE);
    // fallback
    const container = NS.$('#locator-list');
    container.innerHTML = '<div class="small">No custom locators available.</div>';
  }

  // Render, clear, file open wiring
  function wireButtons(){
    document.getElementById('btnRender')?.addEventListener('click', async ()=>{
      const paste = NS.$('#pasteBox');
      const html = paste && paste.value ? paste.value : '';
      NS.CURRENT_HTML = html || '';
      const preview = NS.$('#preview');
      if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe'){
        let srcdoc = html || '<!doctype html><meta charset="utf-8"><body><h3>No content</h3></body>';
        try { srcdoc = srcdoc.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,''); } catch(e){}
        try { preview.srcdoc = srcdoc; } catch(e){ NS.showToast('Unable to set iframe srcdoc', 'error'); }
      } else {
        // fallback to parser doc
        try { window._PARSER_DOC = (new DOMParser()).parseFromString(html,'text/html'); } catch(e){}
      }
      try { window._PARSER_DOC = (new DOMParser()).parseFromString(html,'text/html'); } catch(e){}
      setTimeout(()=>{ try { NS.attachHandlersToPreview(); NS.extractAllLocators(); } catch(e){} }, 350);
      NS.showToast('Preview rendered', 'success');
    });
    document.getElementById('btnClear')?.addEventListener('click', ()=>{
      try {
        const paste = NS.$('#pasteBox'); if(paste) paste.value = '';
        const preview = NS.$('#preview'); if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe') preview.srcdoc = '<body><h3>Cleared</h3></body>';
        NS.CURRENT_HTML=''; NS.CURRENT_LOCATORS=[]; NS.CURRENT_LOCATORS_SINGLE=null; NS.CUSTOM_LOCATORS=[];
        const list = NS.$('#locator-list'); if(list) list.innerHTML = '';
        const out = NS.$('#output'); if(out) out.value = '';
        NS.showToast('Cleared', 'info');
      } catch(e){ console.warn(e); }
    });
    document.getElementById('btnOpenFile')?.addEventListener('click', ()=> NS.$('#hiddenFile')?.click());
    document.getElementById('hiddenFile')?.addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = function(e){ const p = NS.$('#pasteBox'); if(p) p.value = e.target.result; NS.$('#btnRender')?.click(); };
      reader.readAsText(f);
    });
  }

  // POM generation preview-only (fills #output). Download ZIP explicit.
  function wirePOM(){
    document.getElementById('btnGenPOM')?.addEventListener('click', ()=>{
      try {
        const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
        const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
        const locs = NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || [];
        const files = NS.buildArtifactsFiles({ fw, lang, locs });
        const out = NS.$('#output');
        if(out) out.value = Object.keys(files).map(k=>`// ==== ${k} ====\n${files[k]}`).join('\n\n');
        NS.showToast('POM preview generated', 'success');
      } catch(e){ console.error(e); NS.showToast('Generate failed', 'error'); }
    });

    document.getElementById('btnZipAll')?.addEventListener('click', async ()=>{
      try {
        if(!window.JSZip){ NS.showToast('JSZip required for zip', 'error'); return; }
        const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
        const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
        const files = NS.buildArtifactsFiles({ fw, lang, locs: NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || [] });
        const zip = new JSZip();
        Object.keys(files).forEach(k=> zip.file(k, files[k]));
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `adhy-${fw}-${lang}.zip`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        NS.showToast('ZIP downloaded', 'success');
      } catch(e){ console.error(e); NS.showToast('ZIP failed', 'error'); }
    });
  }

  // init wires
  setTimeout(()=>{
    try { wireToolbar(); wirePanelTabs(); wireButtons(); wirePOM(); } catch(e){ console.warn(e); }
  }, 80);

  // expose wires for manual re-run
  NS._wireToolbar = wireToolbar;
  NS._wirePanelTabs = wirePanelTabs;
  NS._wireButtons = wireButtons;
  NS._wirePOM = wirePOM;
})();

// -------------------- Phase 9: Build artifacts (preview-only) --------------------
(function(){
  function _normLocs(locs){
    return (locs||[]).map((l,i)=>{
      if(typeof l === 'string') return { name:`elem${i+1}`, xpath: l };
      const name = (l.name || l.text || `elem${i+1}`).toString().replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40);
      const xpath = l.xpath || (l.xpaths && (l.xpaths.basic || l.xpaths.wildcards)) || l.css || `//*[@id='${name}']`;
      return { name, xpath };
    });
  }

  NS.buildArtifactsFiles = function(options){
    options = options || {};
    const fw = (options.fw||'selenium').toLowerCase();
    const lang = (options.lang||'java').toLowerCase();
    const locs = _normLocs(options.locs || (NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || []));
    const files = {};
    files['README.md'] = '# Adhyan Preview\nGenerated by Adhyan Offline Studio\n';
    if(fw === 'selenium' && lang === 'java'){
      const fields = locs.map(l=>`    @FindBy(xpath = "${l.xpath.replace(/"/g,'\\"')}")\n    private WebElement ${l.name};`).join('\n\n');
      const methods = locs.map(l=> {
        const cap = l.name.charAt(0).toUpperCase()+l.name.slice(1);
        return `    public void click${cap}(){ ${l.name}.click(); }`;
      }).join('\n\n');
      files['SamplePage.java'] = `package com.pageobjects;\n\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.support.FindBy;\nimport org.openqa.selenium.support.PageFactory;\n\npublic class SamplePage {\n    WebDriver driver;\n\n${fields}\n\n    public SamplePage(WebDriver driver){\n        this.driver = driver;\n        PageFactory.initElements(driver, this);\n    }\n\n${methods}\n}\n`;
      return files;
    }
    files['locators.txt'] = locs.map(l=>`${l.name}: ${l.xpath}`).join('\n');
    return files;
  };
})();

// -------------------- Phase 10: Startup --------------------
(function(){
  try { NS.fillLocatorList && NS.fillLocatorList('basic'); } catch(e){}
  try { NS.attachHandlersToPreview && NS.attachHandlersToPreview(); } catch(e){}
  // add "custom" chip if not present so UI can switch to it
  try {
    if(!document.querySelector('.chip[data-paneltab="custom"]')){
      const target = document.getElementById('locatorTabs');
      if(target){
        const ch = document.createElement('div'); ch.className='chip'; ch.dataset.paneltab='custom'; ch.textContent='Custom';
        target.appendChild(ch);
        // re-wire panel tabs so the new chip works
        NS._wirePanelTabs && NS._wirePanelTabs();
      }
    }
  } catch(e){}
  console.info('offlineXpath.js loaded. Version:', NS.version);
})();




















/* offlineXpath.js
   Adhyan Offline — merged script (Preview-first, Interactive Custom tab, POM preview)
   Replace your existing offlineXpath.js with this file.
*/
(function(){

  // Namespace
  window.AdhyPatch = window.AdhyPatch || {};
  const NS = window.AdhyPatch;

  // ---------- Phase 1: State ----------
  NS.version = NS.version || 'adhy-offline-3.1';
  NS.CURRENT_HTML = NS.CURRENT_HTML || '';
  NS.CURRENT_LOCATORS = NS.CURRENT_LOCATORS || [];        // list of extracted items
  NS.CURRENT_CUSTOM = NS.CURRENT_CUSTOM || [];            // list of clicked items appended to Custom
  NS.POM_CACHE = NS.POM_CACHE || { pom: '', steps: '' };

  // ---------- Phase 2: Utilities ----------
  (function(){
    NS.$ = NS.$ || function(sel, root=document){ try { return (root || document).querySelector(sel); } catch(e){ return null; } };
    NS.$$ = NS.$$ || function(sel, root=document){ try { return Array.from((root || document).querySelectorAll(sel)); } catch(e){ return []; } };

    NS.showToast = NS.showToast || function(msg, type='info'){
      try {
        let t = document.getElementById('__adhy_toast');
        if(!t){
          t = document.createElement('div');
          t.id = '__adhy_toast';
          t.style.cssText = 'position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.78);color:#fff;z-index:2147483647;font-family:system-ui,Arial';
          document.body.appendChild(t);
        }
        t.textContent = msg;
        t.style.background = (type==='error')? '#b91c1c' : (type==='success')? '#047857' : 'rgba(0,0,0,0.78)';
        t.style.opacity = '1';
        clearTimeout(t._t);
        t._t = setTimeout(()=>{ t.style.opacity='0'; }, 1500);
      } catch(e){ console.log(msg); }
    };

    NS.copyToClipboard = NS.copyToClipboard || async function(text){
      try {
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          NS.showToast('Copied', 'success');
          return true;
        }
      } catch(e){}
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select();
        document.execCommand && document.execCommand('copy');
        ta.remove();
        NS.showToast('Copied (fallback)', 'success');
        return true;
      } catch(e){
        NS.showToast('Copy failed', 'error');
        return false;
      }
    };

    NS.escapeHtml = NS.escapeHtml || function(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };

    NS.xpathLiteral = NS.xpathLiteral || function(s){
      s = String(s||'');
      if (s.indexOf('"') === -1) return `"${s}"`;
      if (s.indexOf("'") === -1) return `'${s}'`;
      const parts = s.split('"'), out=[];
      for(let i=0;i<parts.length;i++){
        if(parts[i] !== '') out.push(`"${parts[i].replace(/\\/g,'\\\\')}"`);
        if(i < parts.length-1) out.push(`'"'`);
      }
      return `concat(${out.join(',')})`;
    };

    NS.cssSelectorFor = NS.cssSelectorFor || function(el){
      if(!el || !el.tagName) return '';
      if(el.id){
        try { return `#${CSS.escape(el.id)}`; } catch(e){ return '#'+el.id; }
      }
      let sel = el.tagName.toLowerCase();
      try {
        if(el.classList && el.classList.length){
          sel += '.' + Array.from(el.classList).slice(0,3).map(c=>c.replace(/\s+/g,'')).join('.');
        }
        const name = el.getAttribute && el.getAttribute('name');
        if(name) sel += `[name="${name}"]`;
      } catch(e){}
      return sel;
    };

  })();

  // ---------- Phase 3: Preview helpers ----------
  (function(){
    const PREVIEW_SEL = ['#preview','iframe#preview','.preview','iframe.preview'];

    function getPreviewElement(){
      for(const s of PREVIEW_SEL){
        try {
          const el = document.querySelector(s);
          if(el) return el;
        } catch(e){}
      }
      try { return document.querySelector('iframe'); } catch(e){ return null; }
    }

    function getPreviewDocument(){
      const el = getPreviewElement();
      if(!el) return window._PARSER_DOC || document;
      if(el.tagName && el.tagName.toLowerCase()==='iframe'){
        try { if(el.contentDocument) return el.contentDocument; } catch(e){}
        if(el.srcdoc) try { return (new DOMParser()).parseFromString(el.srcdoc,'text/html'); } catch(e){}
      }
      try {
        if(el.querySelector){
          const inner = el.querySelector('iframe');
          if(inner && inner.contentDocument) return inner.contentDocument;
        }
      } catch(e){}
      return window._PARSER_DOC || document;
    }

    window.getPreviewElement = getPreviewElement;
    window.getPreviewDocument = getPreviewDocument;
    NS.getPreviewElement = getPreviewElement;
    NS.getPreviewDocument = getPreviewDocument;
  })();

  // ---------- Phase 4: Iframe / Shadow traversal & highlight ----------
  (function(){
    function evaluateXPath(doc, xpath){
      try { return doc.evaluate(xpath, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue; } catch(e){ return null; }
    }

    function findInShadowRoots(xpath, root){
      try {
        const direct = evaluateXPath(root, xpath);
        if(direct) return direct;
      } catch(e){}
      try {
        const walker = root.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null, false);
        let node = walker.nextNode();
        while(node){
          if(node.shadowRoot){
            const found = findInShadowRoots(xpath, node.shadowRoot);
            if(found) return found;
          }
          node = walker.nextNode();
        }
      } catch(e){}
      return null;
    }

    function findInIframes(xpath, win){
      win = win || window;
      try {
        const doc = win.document;
        const d = evaluateXPath(doc, xpath);
        if(d) return { el: d, win };
        const s = findInShadowRoots(xpath, doc);
        if(s) return { el: s, win };
        const frames = doc.querySelectorAll ? Array.from(doc.querySelectorAll('iframe,frame')) : [];
        for(let i=0;i<frames.length;i++){
          const fr = frames[i];
          try {
            if(!fr.contentWindow) continue;
            const res = findInIframes(xpath, fr.contentWindow);
            if(res && res.el) return res;
          } catch(e){ /* cross-origin */ }
        }
      } catch(e){}
      return null;
    }

    function transientHighlightElement(el, opts){
      if(!el || !el.style) return;
      opts = opts || {};
      const color = opts.color || 'rgba(124,92,255,0.45)';
      const orig = { outline: el.style.outline || '', boxShadow: el.style.boxShadow || '', zIndex: el.style.zIndex || '' };
      try { el.style.outline = `3px solid ${color}`; el.style.boxShadow = `0 0 0 4px ${color}`; el.style.zIndex = 2147483647; el.scrollIntoView({behavior:'auto', block:'center'}); } catch(e){}
      setTimeout(()=>{ try { el.style.outline = orig.outline; el.style.boxShadow = orig.boxShadow; el.style.zIndex = orig.zIndex; } catch(e){} }, opts.duration || 1800);
    }

    NS.findInIframes = findInIframes;
    NS.transientHighlightElement = transientHighlightElement;

    NS.tryHighlightByXPath = function(xpath){
      if(!xpath) return false;
      try {
        const docFound = evaluateXPath(document, xpath);
        if(docFound){ transientHighlightElement(docFound, {color:'rgba(255,165,0,0.6)'}); return true; }
      } catch(e){}
      try {
        const previewEl = NS.getPreviewElement && NS.getPreviewElement();
        if(previewEl && previewEl.tagName && previewEl.tagName.toLowerCase()==='iframe'){
          try {
            const pd = previewEl.contentDocument;
            if(pd){
              const pfound = evaluateXPath(pd, xpath) || findInShadowRoots(xpath, pd);
              if(pfound){ transientHighlightElement(pfound, {color:'rgba(0,150,255,0.45)'}); return true; }
            }
          } catch(err){}
        }
      } catch(e){}
      try {
        const res = findInIframes(xpath, window);
        if(res && res.el){ transientHighlightElement(res.el, {color:'rgba(0,150,255,0.45)'}); return true; }
      } catch(e){}
      return false;
    };
  })();

  // ---------- Phase 5: Locator generation strategies ----------
  (function(){
    function safeAttr(el, name){ try { return el.getAttribute ? el.getAttribute(name) : null; } catch(e){ return null; } }
    function getLabelFor(el){
      try {
        if(!el) return '';
        const id = el.id;
        if(id){
          try { const l = document.querySelector && document.querySelector(`label[for="${id}"]`); if(l) return l.textContent.trim(); } catch(e){}
        }
        if(el.closest){
          const parentLabel = el.closest('label'); if(parentLabel) return parentLabel.textContent.trim();
        }
        const txt = (el.innerText || el.textContent || '').trim();
        if(txt) return txt.slice(0,120);
        const placeholder = safeAttr(el,'placeholder'); if(placeholder) return placeholder;
        return '';
      } catch(e){ return ''; }
    }

    function genBasicXPath(el){
      if(!el) return '';
      if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
      const tag = el.tagName.toLowerCase();
      const name = safeAttr(el,'name');
      if(name) return `//${tag}[@name=${NS.xpathLiteral(name)}]`;
      const label = getLabelFor(el);
      if(label) return `//${tag}[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
      // fallback: limited absolute
      const parts = [];
      let cur = el; let depth=0;
      while(cur && cur.nodeType===1 && depth<8){
        const t = cur.tagName.toLowerCase();
        let ix = 1; let sib = cur.previousElementSibling;
        while(sib){ if(sib.tagName === cur.tagName) ix++; sib = sib.previousElementSibling; }
        parts.unshift(`${t}${ix>1?`[${ix}]`:''}`);
        cur = cur.parentElement; depth++;
      }
      return '//' + parts.join('/');
    }

    function genWildcardXPath(el){
      if(!el) return '';
      if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
      const label = getLabelFor(el);
      if(label) return `//*[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
      const name = safeAttr(el,'name'); if(name) return `//*[contains(@name, ${NS.xpathLiteral(name)})]`;
      const cls = (safeAttr(el,'class')||'').split(/\s+/).filter(Boolean)[0];
      if(cls) return `//*[contains(concat(' ', normalize-space(@class), ' '), ${NS.xpathLiteral(' '+cls+' ')})]`;
      return genBasicXPath(el);
    }

    function genAxesXPath(el){
      if(!el) return genBasicXPath(el);
      const tag = el.tagName.toLowerCase();
      const id = el.id;
      if(id) return `//label[@for=${NS.xpathLiteral(id)}]/following::${tag}[1]`;
      const label = getLabelFor(el);
      if(label) return `//label[contains(normalize-space(.), ${NS.xpathLiteral(label)})]/following::${tag}[1]`;
      return genBasicXPath(el);
    }

    function genFunctionXPath(el){
      if(!el) return genBasicXPath(el);
      const tag = el.tagName.toLowerCase();
      const placeholder = safeAttr(el,'placeholder'); if(placeholder) return `//${tag}[contains(@placeholder, ${NS.xpathLiteral(placeholder)})]`;
      const title = safeAttr(el,'title'); if(title) return `//${tag}[contains(@title, ${NS.xpathLiteral(title)})]`;
      const aria = safeAttr(el,'aria-label'); if(aria) return `//${tag}[@aria-label=${NS.xpathLiteral(aria)}]`;
      return genBasicXPath(el);
    }

    function genSalesforceXPath(el){
      if(!el) return '';
      const tag = el.tagName.toLowerCase();
      if(safeAttr(el,'data-qa-locator')) return `//${tag}[@data-qa-locator=${NS.xpathLiteral(safeAttr(el,'data-qa-locator'))}]`;
      if(safeAttr(el,'data-id')) return `//${tag}[@data-id=${NS.xpathLiteral(safeAttr(el,'data-id'))}]`;
      if(safeAttr(el,'data-aura-rendered-by')) return `//${tag}[@data-aura-rendered-by=${NS.xpathLiteral(safeAttr(el,'data-aura-rendered-by'))}]`;
      return '';
    }

    function genPegaXPath(el){
      if(!el) return '';
      const tag = el.tagName.toLowerCase();
      if(safeAttr(el,'data-test-id')) return `//${tag}[@data-test-id=${NS.xpathLiteral(safeAttr(el,'data-test-id'))}]`;
      if(safeAttr(el,'data-ctl')) return `//${tag}[@data-ctl=${NS.xpathLiteral(safeAttr(el,'data-ctl'))}]`;
      return '';
    }

    NS.genBasicXPath = genBasicXPath;
    NS.genWildcardXPath = genWildcardXPath;
    NS.genAxesXPath = genAxesXPath;
    NS.genFunctionXPath = genFunctionXPath;
    NS.genSalesforceXPath = genSalesforceXPath;
    NS.genPegaXPath = genPegaXPath;

    NS.generateLocatorsForElement = function(el){
      if(!el) return null;
      return {
        tag: el.tagName.toLowerCase(),
        id: el.id || '',
        text: getLabelFor(el) || '',
        xpaths: {
          basic: genBasicXPath(el),
          wildcards: genWildcardXPath(el),
          axes: genAxesXPath(el),
          functions: genFunctionXPath(el),
          salesforce: genSalesforceXPath(el),
          pega: genPegaXPath(el)
        },
        css: NS.cssSelectorFor(el),
        elementRef: el
      };
    };

  })();

  // ---------- Phase 6: Extraction & UI fill ----------
  (function(){

    function shouldSkip(el){
      try {
        if(!el || el.nodeType !== 1) return true;
        if(el.hasAttribute && el.hasAttribute('hidden')) return true;
        const s = (el.getAttribute && el.getAttribute('style') || '').toLowerCase();
        if(s && (/display\s*:\s*none|visibility\s*:\s*hidden/).test(s)) return true;
        if(el.tagName && el.tagName.toLowerCase()==='script') return true;
        if(el.tagName && el.tagName.toLowerCase()==='a' && (!el.hasAttribute('href') || el.getAttribute('href')==='')) return true;
      } catch(e){ return true; }
      return false;
    }

    function collectCandidateElements(doc){
      doc = doc || document;
      const selectors = ['input:not([type=hidden])','button','a[href]','select','textarea','[role="button"]','[data-qa-locator]','[data-test-id]','[data-ctl]','lightning-input','lightning-button'];
      let list = [];
      try { list = Array.from(doc.querySelectorAll(selectors.join(','))); } catch(e){ list = []; }
      list = list.filter(el => !shouldSkip(el));
      const seen = new Set(); const out = [];
      list.forEach(el=>{
        try {
          const sig = [el.tagName.toLowerCase(), el.id||'', el.getAttribute && el.getAttribute('name')||'', (el.textContent||'').trim().slice(0,60)].join('|');
          if(seen.has(sig)) return; seen.add(sig); out.push(el);
        } catch(e){}
      });
      return out;
    }

    NS.extractAllLocators = function(opts){
      opts = opts || {};
      let DOC = document;
      const previewEl = NS.getPreviewElement && NS.getPreviewElement();
      if(previewEl && previewEl.tagName && previewEl.tagName.toLowerCase()==='iframe' && !opts.forceParse){
        try { if(previewEl.contentDocument) DOC = previewEl.contentDocument; } catch(e){ if(window._PARSER_DOC) DOC = window._PARSER_DOC; else { DOC = document; NS.showToast('Preview inaccessible — using parsed DOM','warn'); } }
      } else if(window._PARSER_DOC){
        DOC = window._PARSER_DOC;
      }
      const elements = collectCandidateElements(DOC);
      const results = elements.map((el, idx)=>{ const loc = NS.generateLocatorsForElement(el); loc._srcIndex = idx; loc._id = loc.id || `E${idx+1}`; return loc; });
      NS.CURRENT_LOCATORS = results;
      try { NS.fillLocatorList && NS.fillLocatorList('basic'); } catch(e){ console.warn('fillLocatorList', e); }
      NS.showToast(`Extracted ${results.length} elements`);
      return results;
    };

    // Fill the visible locator list (used for Basic/Wildcards/etc)
    NS.fillLocatorList = function(panel='basic'){
      panel = panel || 'basic';
      const container = NS.$('#locator-list');
      if(!container){
        console.warn('#locator-list not found'); return;
      }

      // We'll show a tabbed view: but main list goes into a child .list area
      // Create or find #locList (visible area)
      let listArea = NS.$('#locList');
      if(!listArea){
        listArea = document.createElement('div'); listArea.id = 'locList'; listArea.className = 'list';
        container.innerHTML = ''; container.appendChild(listArea);
      } else {
        listArea.innerHTML = '';
      }

      const data = NS.CURRENT_LOCATORS || [];
      if(!data.length){
        listArea.innerHTML = '<div class="small">No locators. Paste/Render to populate.</div>'; return;
      }

      data.forEach((it, idx)=>{
        const val = (it.xpaths && it.xpaths[panel]) || it.css || '';
        const row = document.createElement('div'); row.className = 'loc-row';
        row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
        // left: label
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
        const badge = document.createElement('span'); badge.className='badge'; badge.textContent = it.tag || 'el';
        const meta = document.createElement('div'); meta.style.minWidth='0';
        meta.innerHTML = `<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:220px">${NS.escapeHtml(it.text||'(no text)')}</div><div class="small" style="color:#6b7280">${NS.escapeHtml(it._id || '')}</div>`;
        left.appendChild(badge); left.appendChild(meta);

        // mid: value
        const mid = document.createElement('div'); mid.className='mono'; mid.style.flex='1'; mid.style.margin='0 12px'; mid.style.whiteSpace='nowrap'; mid.style.overflow='hidden'; mid.style.textOverflow='ellipsis';
        mid.textContent = val;

        // actions
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
        const btnCopy = document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Copy';
        const btnHi = document.createElement('button'); btnHi.className='btn'; btnHi.textContent='Highlight';
        actions.appendChild(btnCopy); actions.appendChild(btnHi);

        row.appendChild(left); row.appendChild(mid); row.appendChild(actions);

        // Row click: copy + highlight + append to output + toggle selection behavior
        row.addEventListener('click', async (e)=>{
          if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON')) return;
          const copyVal = mid.textContent || '';
          if(!copyVal) return NS.showToast('No locator', 'error');
          const ok = NS.tryHighlightByXPath(copyVal);
          await NS.copyToClipboard(copyVal);
          // Append snippet for this locator into output (non-destructive)
          const out = NS.$('#output'); if(out){ out.value = (out.value? out.value + '\n\n' : '') + `// ${it._id} (${panel})\n${copyVal}`; }
          NS.showToast(ok ? 'Copied & highlighted' : 'Copied');
        });

        btnCopy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); const v = mid.textContent || ''; if(!v) return; await NS.copyToClipboard(v); });
        btnHi.addEventListener('click', (ev)=>{ ev.stopPropagation(); const v = mid.textContent || ''; if(v) NS.tryHighlightByXPath(v); });

        listArea.appendChild(row);
      });

    };

  })();

  // ---------- Phase 7: Interactive preview click → Custom tab ----------
  (function(){

    // When user clicks inside preview, generate locators for that element and append into CUSTOM list
    async function previewClickHandler(e){
      try {
        e.preventDefault && e.preventDefault();
        e.stopPropagation && e.stopPropagation();
        const el = e.target;
        if(!el || !el.tagName) return;
        const loc = NS.generateLocatorsForElement(el);
        if(!loc) { NS.showToast('Unable to compute locators', 'error'); return; }

        // Build unique id
        const uid = (loc.id && loc.id.length) ? loc.id : `C${Date.now().toString(36).slice(-6)}`;
        loc._uid = uid;

        // Append to CUSTOM array and to UI under "Custom" tab area
        NS.CURRENT_CUSTOM = NS.CURRENT_CUSTOM || [];
        NS.CURRENT_CUSTOM.push(loc);

        // Ensure Custom tab exists; if not, create or activate a "custom" area by reusing #locList but with flag
        // For simplicity we'll switch the visible tab to a "Custom view" inside locator-list area
        showCustomTabAndItem(loc);

        // Append snippet to output
        const snippet = buildSnippetForElement(loc);
        const out = NS.$('#output');
        if(out) out.value = (out.value ? out.value + '\n\n' : '') + snippet;

        NS.showToast('Captured element into Custom tab', 'success');
      } catch(err){ console.error('previewClickHandler', err); NS.showToast('Capture failed','error'); }
    }

    function showCustomTabAndItem(loc){
      // Mark the Custom tab active (if you have tab DOM). We will:
      // - Set all .chip to inactive and create/activate a "custom" chip,
      // - Render the single loc's strategies in #locList and highlight the entry (selectable).
      const tabs = document.querySelectorAll('.chip');
      tabs.forEach(t => t.classList.remove('active'));
      // create/find a custom chip
      let customChip = document.querySelector('.chip[data-paneltab="custom"]');
      if(!customChip){
        customChip = document.createElement('div');
        customChip.className = 'chip';
        customChip.dataset.paneltab = 'custom';
        customChip.textContent = 'Custom';
        const tabParent = document.getElementById('locatorTabs');
        if(tabParent) tabParent.appendChild(customChip);
        customChip.addEventListener('click', ()=> { customChip.classList.add('active'); renderCustomList(); });
      }
      customChip.classList.add('active');

      // Render the custom list (show latest at top)
      renderCustomList(loc);
    }

    function renderCustomList(highlightLoc){
      const listContainer = document.getElementById('locList') || (function(){ const c=document.getElementById('locator-list'); if(!c) return null; const d=document.createElement('div'); d.id='locList'; d.className='list'; c.innerHTML=''; c.appendChild(d); return d; })();
      if(!listContainer) return;
      listContainer.innerHTML = '';
      const arr = (NS.CURRENT_CUSTOM || []).slice().reverse(); // show newest first
      arr.forEach((loc, i)=>{
        const row = document.createElement('div'); row.className = 'loc-row';
        row.style.display='flex'; row.style.flexDirection='column'; row.style.gap='6px';
        const titleRow = document.createElement('div'); titleRow.style.display='flex'; titleRow.style.justifyContent='space-between'; titleRow.style.alignItems='center';
        const label = document.createElement('div'); label.innerHTML = `<div style="font-weight:700">${NS.escapeHtml(loc.text || loc.tag)}</div><div class="small" style="color:#6b7280">${NS.escapeHtml(loc.id||loc._uid||'')}</div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
        const btnAppend = document.createElement('button'); btnAppend.className='btn'; btnAppend.textContent='Use';
        const btnCopyAll = document.createElement('button'); btnCopyAll.className='btn'; btnCopyAll.textContent='Copy All';
        const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Delete';
        controls.appendChild(btnAppend); controls.appendChild(btnCopyAll); controls.appendChild(btnDel);
        titleRow.appendChild(label); titleRow.appendChild(controls);

        const strategies = document.createElement('div'); strategies.style.display='flex'; strategies.style.flexDirection='column'; strategies.style.gap='6px';
        ['basic','wildcards','axes','functions','salesforce','pega'].forEach(k=>{
          const v = (loc.xpaths && loc.xpaths[k]) || '';
          const srow = document.createElement('div'); srow.style.display='flex'; srow.style.justifyContent='space-between'; srow.style.alignItems='center';
          const left = document.createElement('div'); left.innerHTML = `<b>${k.toUpperCase()}</b> <span class="mono" style="margin-left:10px">${NS.escapeHtml(v||'(none)')}</span>`;
          const ract = document.createElement('div'); ract.style.display='flex'; ract.style.gap='8px';
          const copy = document.createElement('button'); copy.className='btn'; copy.textContent='Copy';
          const hi = document.createElement('button'); hi.className='btn'; hi.textContent='Highlight';
          copy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(!v) return; await NS.copyToClipboard(v); });
          hi.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!v) return NS.tryHighlightByXPath(v); });
          ract.appendChild(copy); ract.appendChild(hi);
          srow.appendChild(left); srow.appendChild(ract);
          strategies.appendChild(srow);
        });
        // CSS row
        const cssRow = document.createElement('div'); cssRow.style.display='flex'; cssRow.style.justifyContent='space-between'; cssRow.style.alignItems='center';
        cssRow.innerHTML = `<div><b>CSS</b> <span class="mono" style="margin-left:10px">${NS.escapeHtml(loc.css||'(none)')}</span></div>`;
        const cssAct = document.createElement('div'); cssAct.style.display='flex'; cssAct.style.gap='8px';
        const cssCopy = document.createElement('button'); cssCopy.className='btn'; cssCopy.textContent='Copy'; cssCopy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); await NS.copyToClipboard(loc.css||''); });
        cssAct.appendChild(cssCopy);
        cssRow.appendChild(cssAct);

        row.appendChild(titleRow);
        row.appendChild(strategies);
        row.appendChild(cssRow);

        // Use button behavior - when user clicks Use, set a 'selected' locator into output POM generation context
        btnAppend.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          // mark as selected (NS.CURRENT_LOCATORS_SINGLE style)
          NS.CURRENT_LOCATORS_SINGLE = loc;
          // also put into output preview
          const out = NS.$('#output');
          if(out){
            const snippet = buildSnippetForElement(loc);
            out.value = snippet;
          }
          NS.showToast('Selected for POM preview');
        });

        btnCopyAll.addEventListener('click', async (ev)=>{ ev.stopPropagation(); // copy all xpaths combined
          const all = ['basic','wildcards','axes','functions','salesforce','pega'].map(k=> (loc.xpaths && loc.xpaths[k]) || '').filter(Boolean).join('\n');
          if(!all) return NS.showToast('Nothing to copy','warn');
          await NS.copyToClipboard(all);
        });

        btnDel.addEventListener('click', (ev)=>{ ev.stopPropagation();
          // remove from CURRENT_CUSTOM
          NS.CURRENT_CUSTOM = (NS.CURRENT_CUSTOM || []).filter(x => x !== loc);
          renderCustomList();
          NS.showToast('Removed from Custom');
        });

        // highlight newly added
        if(highlightLoc && highlightLoc === loc){
          row.style.boxShadow = '0 6px 18px rgba(124,92,255,0.12)';
        }
        // add row
        listContainer.appendChild(row);
      });
    }

    // Public attach/detach
    NS.attachHandlersToPreview = function(){
      try {
        NS.detachAllPreviewHandlers && NS.detachAllPreviewHandlers();
      } catch(e){}
      const previewEl = NS.getPreviewElement && NS.getPreviewElement();
      if(previewEl && previewEl.tagName && previewEl.tagName.toLowerCase()==='iframe'){
        const attach = (pd)=>{
          try {
            if(!pd) return;
            pd.addEventListener('click', previewClickHandler, true);
            NS.attachPreviewHandler(pd, 'click', previewClickHandler);
          } catch(e){}
        };
        try {
          if(previewEl.contentDocument && (previewEl.contentDocument.readyState==='complete' || previewEl.contentDocument.readyState==='interactive')){
            attach(previewEl.contentDocument);
          } else {
            previewEl.addEventListener('load', ()=>{ try { attach(previewEl.contentDocument); } catch(e){} }, {once:true});
          }
        } catch(e){ /* cross-origin */ }
      } else {
        // if inline preview (rare), attach to doc
        try { document.addEventListener('click', previewClickHandler, true); } catch(e){}
      }
    };

    // helper to register preview listeners into a list so we can detach later
    window._AdhyanPreviewListeners = window._AdhyanPreviewListeners || [];
    NS.attachPreviewHandler = function(doc, type, handler){
      try {
        if(!doc || !doc.addEventListener) return;
        window._AdhyanPreviewListeners.push({doc, type, handler});
      } catch(e){}
    };
    NS.detachAllPreviewHandlers = function(){
      try {
        (window._AdhyanPreviewListeners || []).forEach(o=>{
          try { o.doc.removeEventListener(o.type, o.handler, true); } catch(e){}
        });
        window._AdhyanPreviewListeners = [];
      } catch(e){}
    };

    // expose for tests
    NS._renderCustomList = renderCustomList;

  })();

  // ---------- Phase 8: Render, Clear, UI wiring ----------
  (function(){

    function renderPreviewFromPaste(){
      try {
        const paste = NS.$('#pasteBox');
        const html = paste && paste.value ? paste.value : '';
        NS.CURRENT_HTML = html || '';
        const preview = NS.$('#preview');
        if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe'){
          let srcdoc = html || '<!doctype html><meta charset="utf-8"><body><h3>No content</h3></body>';
          try { srcdoc = srcdoc.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, ''); } catch(e){}
          try { preview.srcdoc = srcdoc; } catch(e){ NS.showToast('Unable to set iframe srcdoc', 'error'); }
        } else {
          // if not iframe, attempt to parse into _PARSER_DOC
        }
        try { window._PARSER_DOC = (new DOMParser()).parseFromString(html,'text/html'); } catch(e){}
        setTimeout(()=>{ try { NS.attachHandlersToPreview && NS.attachHandlersToPreview(); } catch(e){} try { NS.extractAllLocators && NS.extractAllLocators(); } catch(e){} }, 300);
        NS.showToast('Preview rendered', 'success');
      } catch(e){ console.error(e); NS.showToast('Render failed', 'error'); }
    }

    function clearAll(){
      try {
        const paste = NS.$('#pasteBox'); if(paste) paste.value = '';
        const preview = NS.$('#preview'); if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe'){ try{ preview.srcdoc = '<body><h3>Preview cleared</h3></body>'; }catch(e){} }
        NS.CURRENT_HTML = ''; NS.CURRENT_LOCATORS = []; NS.CURRENT_CUSTOM = []; NS.POM_CACHE = {pom:'',steps:''};
        const locList = NS.$('#locList'); if(locList) locList.innerHTML = '';
        const out = NS.$('#output'); if(out) out.value = '';
        NS.showToast('Cleared', 'info');
      } catch(e){ console.warn(e); }
    }

    // Mode chips wiring (POM / API)
    function wireModeChips(){
      try {
        const pom = NS.$('#modePOM'), api = NS.$('#modeAPI');
        if(pom && api){
          pom.addEventListener('click', ()=>{ pom.classList.add('active'); api.classList.remove('active'); NS.$('#pomLeftCard') && NS.$('#pomLeftCard').classList.remove('hidden'); NS.$('#apiLeftCard') && NS.$('#apiLeftCard').classList.add('hidden'); });
          api.addEventListener('click', ()=>{ api.classList.add('active'); pom.classList.remove('active'); NS.$('#apiLeftCard') && NS.$('#apiLeftCard').classList.remove('hidden'); NS.$('#pomLeftCard') && NS.$('#pomLeftCard').classList.add('hidden'); });
        }
      } catch(e){}
    }

    function wireSwGroups(){
      try {
        const sws = document.querySelectorAll('.sw');
        sws.forEach(sw=>{
          sw.addEventListener('click', ()=>{
            const data = Array.from(sw.attributes).find(a=>/^data-/.test(a.name));
            if(!data) return;
            const attrName = data.name;
            const group = document.querySelectorAll(`.sw[${attrName}]`);
            group.forEach(g=>g.classList.remove('active'));
            sw.classList.add('active');
          });
        });
      } catch(e){}
    }

    function ensureDownloadOutputButton(){
      const out = NS.$('#output'); if(!out) return;
      if(document.getElementById('btnDownloadOutput')) return;
      const btn = document.createElement('button'); btn.id='btnDownloadOutput'; btn.className='btn'; btn.textContent='Download Output';
      out.parentNode.insertBefore(btn, out.nextSibling);
      btn.addEventListener('click', ()=>{
        const txt = out.value || '';
        if(!txt) return NS.showToast('Nothing to download', 'error');
        const blob = new Blob([txt], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'adhy-output.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        NS.showToast('Download started', 'success');
      });
    }

    // Wire UI buttons
    document.getElementById('btnRender')?.addEventListener('click', renderPreviewFromPaste);
    document.getElementById('btnClear')?.addEventListener('click', clearAll);
    document.getElementById('btnOpenFile')?.addEventListener('click', ()=> document.getElementById('hiddenFile')?.click());
    document.getElementById('hiddenFile')?.addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = function(e){ const paste = document.getElementById('pasteBox'); if(paste) paste.value = e.target.result; renderPreviewFromPaste(); };
      reader.readAsText(f);
    });

    wireModeChips(); wireSwGroups(); ensureDownloadOutputButton();

    // wire panel tab chips (Basic/Wildcards/...)
    document.getElementById('locatorTabs')?.addEventListener('click', (ev)=>{
      const chip = ev.target.closest('.chip');
      if(!chip) return;
      // ignore custom chip (we manage custom separately)
      const panel = chip.dataset.paneltab;
      if(!panel) return;
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      chip.classList.add('active');
      if(panel === 'custom'){
        // render custom view
        NS._renderCustomList && NS._renderCustomList();
      } else {
        NS.fillLocatorList && NS.fillLocatorList(panel);
      }
    });

    // initial attach handlers after small delay
    setTimeout(()=>{ try { NS.attachHandlersToPreview && NS.attachHandlersToPreview(); } catch(e){} }, 600);

  })();

  // ---------- Phase 9: POM & Steps generation ----------
  (function(){

    function _normLocs(locs){
      return (locs||[]).map((l,i)=>{
        if(typeof l === 'string') return { name:`elem${i+1}`, xpath: l };
        const name = (l.name || l.text || `elem${i+1}`).toString().replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40) || `elem${i+1}`;
        const xpath = l.xpath || (l.xpaths && (l.xpaths.basic || l.xpaths.wildcards)) || l.css || `//*[@id='${name}']`;
        return { name, xpath };
      });
    }

    NS.buildArtifactsFiles = function(options){
      options = options || {};
      const fw = (options.fw||'selenium').toLowerCase();
      const lang = (options.lang||'java').toLowerCase();
      const locs = _normLocs(options.locs || (NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || []));
      const files = {};
      files['README.md'] = '# Generated (preview) by Adhyan Offline Studio\n';
      if(fw === 'selenium' && lang === 'java'){
        const fields = locs.map(l=>`    @FindBy(xpath = "${l.xpath.replace(/"/g,'\\"')}")\n    private WebElement ${l.name};`).join('\n\n');
        const methods = locs.map(l => {
          const cap = l.name.charAt(0).toUpperCase() + l.name.slice(1);
          return `    public void click${cap}(){ ${l.name}.click(); }`;
        }).join('\n\n');
        files['SamplePage.java'] = `package com.pageobjects;\n\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.support.FindBy;\nimport org.openqa.selenium.support.PageFactory;\n\npublic class SamplePage {\n    WebDriver driver;\n\n${fields}\n\n    public SamplePage(WebDriver driver){\n        this.driver = driver;\n        PageFactory.initElements(driver, this);\n    }\n\n${methods}\n}\n`;
        return files;
      }

      if(fw === 'playwright'){
        files['package.json'] = JSON.stringify({ name:'adhyan-pw', devDependencies:{"@playwright/test":"latest"} }, null, 2);
        files['tests/sample.spec.js'] = `const { test } = require('@playwright/test');\n\ntest('sample', async({ page }) => {\n  await page.goto('https://example.com');\n  // Update selectors below\n${locs.map(l=>`  await page.locator('xpath=${l.xpath}').click();`).join('\n')}\n});`;
        return files;
      }

      // fallback plain text
      files['locators.txt'] = locs.map(l=>`${l.name}: ${l.xpath}`).join('\n');
      return files;
    };

    // Generate preview into #output
    document.getElementById('btnGenPOM')?.addEventListener('click', async ()=>{
      try {
        const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
        const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
        const locs = NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || [];
        const files = NS.buildArtifactsFiles({ fw, lang, locs });
        const out = NS.$('#output');
        if(out){
          out.value = Object.keys(files).map(k=>`// ==== ${k} ====\n${files[k]}\n`).join('\n\n');
        }
        NS.showToast('Generated preview in Output', 'success');
      } catch(e){ console.error(e); NS.showToast('Generate failed','error'); }
    });

    // Download ZIP (explicit)
    document.getElementById('btnZipAll')?.addEventListener('click', async ()=>{
      try {
        if(!window.JSZip){ NS.showToast('JSZip required for zip download', 'error'); return; }
        const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
        const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
        const locs = NS.CURRENT_LOCATORS_SINGLE ? [NS.CURRENT_LOCATORS_SINGLE] : NS.CURRENT_LOCATORS || [];
        const files = NS.buildArtifactsFiles({ fw, lang, locs });
        const zip = new JSZip();
        Object.keys(files).forEach(p=> zip.file(p, files[p]));
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `adhy-artifacts-${fw}-${lang}.zip`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        NS.showToast('ZIP downloaded', 'success');
      } catch(e){ console.error(e); NS.showToast('ZIP failed', 'error'); }
    });

  })();

  // ---------- Phase 10: snippet builder ----------
  function buildSnippetForElement(loc){
    try {
      const name = (loc.text || loc.tag || 'elem').replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40) || 'elem';
      const xp = loc.xpaths && (loc.xpaths.basic || loc.xpaths.wildcards || loc.xpaths.axes) || '';
      const css = loc.css || '';
      const code = [
        `// Meta: name=${name}`,
        `// XPath: ${xp}`,
        `// CSS: ${css}`,
        `// Selenium (Java): @FindBy(xpath="${xp.replace(/"/g,'\\"')}") WebElement ${name};`,
        `// Playwright (JS): await page.locator('xpath=${xp}').click();`,
        `// Playwright (CSS): await page.locator('${css}').click();`
      ].join('\n');
      return code;
    } catch(e){ return '// snippet build failed'; }
  }

  // ---------- Phase 11: Startup ----------
  (function(){
    // initial fill (empty)
    try { NS.fillLocatorList && NS.fillLocatorList('basic'); } catch(e){}
    // attach preview handlers (after embed ready)
    try { NS.attachHandlersToPreview && NS.attachHandlersToPreview(); } catch(e){}
    // ensure Download Output exists
    try { /* created by wiring */ } catch(e){}
    console.info('offlineXpath.js loaded. Version:', NS.version);
  })();

  // expose NS for debugging
  window.AdhyPatch = NS;

})(); // EOF




















<script>
/* === AdhyPatch — Full merged script: Custom-tab auto-activate & append on preview click === */
window.AdhyPatch = window.AdhyPatch || {};
const NS = window.AdhyPatch;

// Minimal safe init
NS.version = NS.version || 'adhy-custom-3.1';
NS.CURRENT_LOCATORS = NS.CURRENT_LOCATORS || [];
NS.CUSTOM_LIST = NS.CUSTOM_LIST || [];

// --------------------------------- Utilities ---------------------------------
(function(){
  NS.$ = NS.$ || ((s, root=document) => { try { return (root||document).querySelector(s); } catch(e){ return null; }});
  NS.$$ = NS.$$ || ((s, root=document) => { try { return Array.from((root||document).querySelectorAll(s)); } catch(e){ return []; }});

  NS.showToast = NS.showToast || function(msg, type='info'){
    try {
      let t = document.getElementById('__adhy_toast');
      if(!t){
        t = document.createElement('div');
        t.id = '__adhy_toast';
        t.style.cssText = 'position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.78);color:#fff;z-index:2147483647;font-family:system-ui,Segoe UI,Roboto;opacity:1;transition:opacity .18s';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.background = (type==='error')? '#b91c1c' : (type==='success')? '#047857' : 'rgba(0,0,0,0.78)';
      t.style.opacity = '1';
      clearTimeout(t._t);
      t._t = setTimeout(()=> { try{ t.style.opacity = '0'; } catch(e){} }, 1500);
    } catch(e){ console.log(msg); }
  };

  NS.copyToClipboard = NS.copyToClipboard || async function(text){
    try {
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        NS.showToast('Copied', 'success');
        return true;
      }
    } catch(e){}
    try {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
      document.body.appendChild(ta); ta.select();
      document.execCommand && document.execCommand('copy');
      document.body.removeChild(ta);
      NS.showToast('Copied (fallback)', 'success');
      return true;
    } catch(e){
      NS.showToast('Copy failed', 'error');
      return false;
    }
  };

  NS.escapeHtml = NS.escapeHtml || function(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };
  NS.xpathLiteral = NS.xpathLiteral || function(s){ s = String(s||''); if (s.indexOf('"') === -1) return `"${s}"`; if (s.indexOf("'") === -1) return `'${s}'`; return `"${s.replace(/"/g,'\\"')}"`; };
  NS.cssSelectorFor = NS.cssSelectorFor || function(el){ if(!el||!el.tagName) return ''; if(el.id) return '#'+el.id; let sel = el.tagName.toLowerCase(); if(el.classList && el.classList.length) sel += '.' + Array.from(el.classList).slice(0,3).join('.'); if(el.getAttribute && el.getAttribute('name')) sel += `[name="${el.getAttribute('name')}"]`; return sel; };
})();

// --------------------------- Preview helpers ---------------------------
(function(){
  NS.getPreviewElement = function(){
    return NS.$('#preview') || document.querySelector('iframe#preview') || document.querySelector('iframe') || null;
  };
  NS.getPreviewDocument = function(){
    const p = NS.getPreviewElement();
    if(!p) return window._PARSER_DOC || document;
    try { if(p.tagName && p.tagName.toLowerCase()==='iframe' && p.contentDocument) return p.contentDocument; } catch(e){}
    if(window._PARSER_DOC) return window._PARSER_DOC;
    return document;
  };
})();

// ------------------------- Locator generators -------------------------
(function(){
  function safeAttr(el, name){ try { return el.getAttribute ? el.getAttribute(name) : null; } catch(e){ return null; } }
  function getLabelFor(el){
    try {
      if(!el) return '';
      if(el.id){
        try { const lab = (document.querySelector && document.querySelector(`label[for="${el.id}"]`)); if(lab && lab.textContent) return lab.textContent.trim(); }catch(e){}
      }
      const p = el.closest && el.closest('label'); if(p && p.textContent) return p.textContent.trim();
      const t = (el.innerText || el.textContent || '').trim();
      if(t) return t.slice(0,160);
      const ph = safeAttr(el,'placeholder'); if(ph) return ph;
      return '';
    } catch(e){ return ''; }
  }

  NS.genBasicXPath = function(el){
    if(!el) return '';
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const tag = el.tagName.toLowerCase();
    const name = safeAttr(el,'name'); if(name) return `//${tag}[@name=${NS.xpathLiteral(name)}]`;
    const label = getLabelFor(el); if(label) return `//${tag}[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    // fallback short path
    const parts=[]; let cur=el; let depth=0;
    while(cur && cur.nodeType===1 && depth<8){
      const t = cur.tagName.toLowerCase();
      let ix = 1; let sib = cur.previousElementSibling;
      while(sib){ if(sib.tagName === cur.tagName) ix++; sib = sib.previousElementSibling; }
      parts.unshift(`${t}${ix>1?`[${ix}]`:''}`); cur = cur.parentElement; depth++;
    }
    return '//' + parts.join('/');
  };

  NS.genWildcardXPath = function(el){
    if(!el) return '';
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const label = getLabelFor(el);
    if(label) return `//*[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    const cls = safeAttr(el,'class') || '';
    if(cls) {
      const first = cls.split(/\s+/).filter(Boolean)[0];
      if(first) return `//*[contains(concat(' ', normalize-space(@class), ' '), ${NS.xpathLiteral(' '+first+' ')})]`;
    }
    return NS.genBasicXPath(el);
  };

  NS.genAxesXPath = function(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    const id = el.id;
    if(id) return `//label[@for=${NS.xpathLiteral(id)}]/following::${tag}[1]`;
    const lab = getLabelFor(el);
    if(lab) return `//label[contains(normalize-space(.), ${NS.xpathLiteral(lab)})]/following::${tag}[1]`;
    return NS.genBasicXPath(el);
  };

  NS.genFunctionXPath = function(el){
    if(!el) return NS.genBasicXPath(el);
    const tag = el.tagName.toLowerCase();
    const ph = safeAttr(el,'placeholder'); if(ph) return `//${tag}[contains(@placeholder, ${NS.xpathLiteral(ph)})]`;
    const aria = safeAttr(el,'aria-label'); if(aria) return `//${tag}[@aria-label=${NS.xpathLiteral(aria)}]`;
    return NS.genBasicXPath(el);
  };

  NS.genSalesforceXPath = function(el){
    if(!el) return '';
    if(safeAttr(el,'data-qa-locator')) return `//*[@data-qa-locator=${NS.xpathLiteral(safeAttr(el,'data-qa-locator'))}]`;
    if(safeAttr(el,'data-id')) return `//*[@data-id=${NS.xpathLiteral(safeAttr(el,'data-id'))}]`;
    return '';
  };

  NS.genPegaXPath = function(el){
    if(!el) return '';
    if(safeAttr(el,'data-test-id')) return `//*[@data-test-id=${NS.xpathLiteral(safeAttr(el,'data-test-id'))}]`;
    if(safeAttr(el,'data-ctl')) return `//*[@data-ctl=${NS.xpathLiteral(safeAttr(el,'data-ctl'))}]`;
    return '';
  };

  NS.generateLocatorsForElement = function(el){
    if(!el) return null;
    return {
      tag: el.tagName.toLowerCase(),
      text: getLabelFor(el) || '',
      xpaths: {
        basic: NS.genBasicXPath(el),
        wildcards: NS.genWildcardXPath(el),
        axes: NS.genAxesXPath(el),
        functions: NS.genFunctionXPath(el),
        salesforce: NS.genSalesforceXPath(el),
        pega: NS.genPegaXPath(el)
      },
      css: NS.cssSelectorFor(el)
    };
  };
})();

// -------------------- Custom list UI helpers --------------------
(function(){
  // ensure Custom tab exists (if not, create a 'custom' chip)
  function ensureCustomChip(){
    let customChip = NS.$('.chip[data-paneltab="custom"]');
    if(!customChip){
      const tabs = NS.$('#locatorTabs');
      if(!tabs) return null;
      customChip = document.createElement('div');
      customChip.className = 'chip';
      customChip.dataset.paneltab = 'custom';
      customChip.textContent = 'Custom';
      tabs.appendChild(customChip);
      customChip.addEventListener('click', ()=>{ activatePanel('custom'); });
    }
    return customChip;
  }

  function activatePanel(name){
    NS.$$('.chip').forEach(c=>c.classList.remove('active'));
    const chip = NS.$(`.chip[data-paneltab="${name}"]`);
    if(chip) chip.classList.add('active');
    // if switching to non-custom, we can re-render main list. If switching to custom, show custom.
    if(name === 'custom') {
      renderCustomList();
    } else {
      // show default extraction for the panel name if available
      NS.fillLocatorList && NS.fillLocatorList(name);
    }
  }

  // render single 'loc-row' (strategy row) element
  function buildRow(idx, strategyLabel, value){
    const row = document.createElement('div');
    row.className = 'loc-row';
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '8px';
    // left badge (index)
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = idx+1;
    // strategy label
    const lbl = document.createElement('div'); lbl.style.width='110px'; lbl.style.fontWeight='700'; lbl.textContent = strategyLabel;
    // value
    const vdiv = document.createElement('div'); vdiv.className='mono'; vdiv.style.flex='1'; vdiv.style.wordBreak='break-word'; vdiv.style.whiteSpace='pre-wrap'; vdiv.textContent = value || '(none)';
    // actions
    const copy = document.createElement('button'); copy.className='btn'; copy.textContent='Copy'; copy.style.width='72px';
    const hi = document.createElement('button'); hi.className='btn'; hi.textContent='Highlight'; hi.style.width='90px';
    // row click = copy + highlight
    row.addEventListener('click', async (e) => {
      if(e.target && e.target.tagName === 'BUTTON') return; // let buttons handle it
      if(!vdiv.textContent) return;
      await NS.copyToClipboard(vdiv.textContent);
      NS.tryHighlightByXPath && NS.tryHighlightByXPath(vdiv.textContent);
    });
    // buttons
    copy.addEventListener('click', async (ev) => { ev.stopPropagation(); if(!vdiv.textContent) return; await NS.copyToClipboard(vdiv.textContent); });
    hi.addEventListener('click', (ev) => { ev.stopPropagation(); if(!vdiv.textContent) return; NS.tryHighlightByXPath && NS.tryHighlightByXPath(vdiv.textContent); });

    row.appendChild(badge); row.appendChild(lbl); row.appendChild(vdiv); row.appendChild(copy); row.appendChild(hi);
    return row;
  }

  // render entire custom list (stacked entries, each showing strategies)
  function renderCustomList(){
    const box = NS.$('#locList');
    if(!box) return;
    box.innerHTML = '';
    if(!Array.isArray(NS.CUSTOM_LIST) || NS.CUSTOM_LIST.length === 0){
      box.innerHTML = '<div class="small">No custom entries. Click elements in the preview to add them.</div>';
      return;
    }
    NS.CUSTOM_LIST.forEach((loc, idx) => {
      // container header for this captured element
      const header = document.createElement('div');
      header.style.padding = '8px'; header.style.borderBottom = '1px solid #e6ecf5'; header.style.background = '#f7f9fc';
      header.innerHTML = `<div style="font-weight:800">${NS.escapeHtml(loc.text||loc.tag||('Element '+(idx+1)))}</div><div class="small" style="color:#6b7280">${NS.escapeHtml(loc.css||'')}</div>`;
      box.appendChild(header);
      // strategies
      const strategies = ['basic','wildcards','axes','functions','salesforce','pega'];
      strategies.forEach(s=>{
        const v = (loc.xpaths && loc.xpaths[s]) || '';
        const row = buildRow(idx, s.toUpperCase(), v || '(none)');
        box.appendChild(row);
      });
      // CSS row
      const cssRow = buildRow(idx, 'CSS', loc.css || '(none)');
      box.appendChild(cssRow);
    });
    // update loc-count if present
    const count = NS.$('#loc-count'); if(count) count.textContent = `${NS.CUSTOM_LIST.length} custom element(s)`;
  }

  // public helpers
  NS.ensureCustomChip = ensureCustomChip;
  NS.activatePanel = activatePanel;
  NS.renderCustomList = renderCustomList;

  // initialize: ensure chip exists and bind default click for existing chips
  setTimeout(()=>{
    NS.ensureCustomChip();
    // wire tab clicks to render correct lists
    NS.$$('.chip').forEach(c=>{
      if(c._bound) return;
      c._bound = true;
      c.addEventListener('click', ()=>{
        const n = c.dataset.paneltab || null;
        if(n) NS.activatePanel(n);
      });
    });
  }, 80);
})();

// -------------------- Attach handlers to preview & click flow --------------------
(function(){
  // helper to attach event listeners to preview doc (iframe or parsed doc)
  function attachToPreviewDoc(){
    const previewEl = NS.getPreviewElement();
    if(!previewEl) return;
    try {
      if(previewEl.tagName && previewEl.tagName.toLowerCase() === 'iframe'){
        // try contentDocument
        try {
          const pd = previewEl.contentDocument;
          if(pd){
            // remove previous listeners we added on that doc (by flag)
            if(pd.__adhy_click_attached) return;
            pd.__adhy_click_attached = true;
            pd.addEventListener('click', previewClickHandler, true);
          } else {
            // attach on load
            previewEl.addEventListener('load', ()=> {
              try { const pd2 = previewEl.contentDocument; if(pd2 && !pd2.__adhy_click_attached){ pd2.__adhy_click_attached = true; pd2.addEventListener('click', previewClickHandler, true); } } catch(e){}
            }, {once:true});
          }
        } catch(e){
          // cross-origin - cannot attach; rely on parsed DOM fallback
          console.warn('Preview iframe cross-origin — click attach skipped');
        }
      } else {
        // it's inline element (rare); attach to its document
        const pd = NS.getPreviewDocument();
        if(pd && !pd.__adhy_click_attached){
          pd.__adhy_click_attached = true;
          pd.addEventListener('click', previewClickHandler, true);
        }
      }
    } catch(e){ console.warn('attachToPreviewDoc failed', e); }
  }

  // click handler inside preview document
  function previewClickHandler(e){
    try {
      e.preventDefault && e.preventDefault();
      e.stopPropagation && e.stopPropagation();
      const el = e.target;
      if(!el || el.nodeType !== 1) return;
      const loc = NS.generateLocatorsForElement(el);
      if(!loc) return;
      // push into custom list
      NS.CUSTOM_LIST = NS.CUSTOM_LIST || [];
      NS.CUSTOM_LIST.push(loc);
      // ensure custom chip exists and activate it
      const customChip = NS.ensureCustomChip();
      if(customChip){
        // activate custom
        NS.activatePanel('custom');
      }
      // render custom list
      NS.renderCustomList();
      NS.showToast('Captured element into Custom', 'success');
      return false;
    } catch(err){
      console.error('previewClickHandler error', err);
      NS.showToast('Capture failed', 'error');
    }
  }

  // public attach function
  NS.attachHandlersToPreview = function(){
    attachToPreviewDoc();
  };

  // attach on startup (if preview exists)
  setTimeout(()=>{ NS.attachHandlersToPreview(); }, 300);
})();

// -------------------- Minimal extraction & fill list (basic behavior preserved) --------------------
(function(){
  function collectCandidateElements(doc){
    try {
      const selectors = ['input:not([type="hidden"])','button','a','select','textarea','[role="button"]','[data-qa-locator]','[data-test-id]','[data-ctl]','lightning-input','lightning-button'];
      return Array.from((doc || document).querySelectorAll(selectors.join(','))).filter(el=>{
        try {
          if(!el) return false;
          if(el.hasAttribute && el.hasAttribute('hidden')) return false;
          const s = el.getAttribute && el.getAttribute('style') || '';
          if(/display\s*:\s*none|visibility\s*:\s*hidden/.test(s)) return false;
          if(el.tagName && el.tagName.toLowerCase()==='script') return false;
          return true;
        } catch(e){ return false; }
      });
    } catch(e){ return []; }
  }

  NS.extractAllLocators = function(){
    const doc = NS.getPreviewDocument();
    const elems = collectCandidateElements(doc);
    NS.CURRENT_LOCATORS = elems.map(el => NS.generateLocatorsForElement(el));
    // default to basic panel rendering if custom is not active
    const active = NS.$('.chip.active')?.dataset?.paneltab || 'basic';
    if(active !== 'custom'){
      NS.fillLocatorList && NS.fillLocatorList(active);
    } else {
      NS.renderCustomList();
    }
    NS.showToast(`Extracted ${NS.CURRENT_LOCATORS.length} elements`);
    return NS.CURRENT_LOCATORS;
  };

  NS.fillLocatorList = function(panel='basic'){
    const container = NS.$('#locList');
    if(!container) return;
    container.innerHTML = '';
    const data = NS.CURRENT_LOCATORS || [];
    if(!data.length){ container.innerHTML = '<div class="small">No locators. Paste/Render to populate.</div>'; return; }
    data.forEach((it, idx)=>{
      const val = (it.xpaths && it.xpaths[panel]) || it.css || '';
      const row = document.createElement('div'); row.className = 'loc-row';
      row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const badge = document.createElement('span'); badge.className='badge'; badge.textContent = it.tag || 'elem';
      const label = document.createElement('div'); label.innerHTML = `<div style="font-weight:700">${NS.escapeHtml(it.text||'(no text)')}</div><div class="small">${NS.escapeHtml(it.css||'')}</div>`;
      left.appendChild(badge); left.appendChild(label);
      const mid = document.createElement('div'); mid.className='mono'; mid.style.flex='1'; mid.style.whiteSpace='nowrap'; mid.style.overflow='hidden'; mid.style.textOverflow='ellipsis'; mid.textContent = val;
      const act = document.createElement('div'); act.style.display='flex'; act.style.gap='6px';
      const btnCopy = document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Copy';
      const btnHi = document.createElement('button'); btnHi.className='btn'; btnHi.textContent='Highlight';
      act.appendChild(btnCopy); act.appendChild(btnHi);
      row.appendChild(left); row.appendChild(mid); row.appendChild(act);
      row.addEventListener('click', async (e)=>{ if(e.target && e.target.tagName === 'BUTTON') return; if(!mid.textContent) return; await NS.copyToClipboard(mid.textContent); NS.tryHighlightByXPath && NS.tryHighlightByXPath(mid.textContent); });
      btnCopy.addEventListener('click', async (ev)=>{ ev.stopPropagation(); await NS.copyToClipboard(mid.textContent || ''); });
      btnHi.addEventListener('click', (ev)=>{ ev.stopPropagation(); NS.tryHighlightByXPath && NS.tryHighlightByXPath(mid.textContent || ''); });
      container.appendChild(row);
    });
  };
})();

// -------------------- Render / Clear wiring (preserve preview-only behavior) --------------------
(function(){
  async function renderPreviewFromPaste(){
    try {
      const paste = NS.$('#pasteBox');
      const html = paste && paste.value ? paste.value : '<!doctype html><meta charset="utf-8"><body><h3>No content</h3></body>';
      NS.CURRENT_HTML = html;
      const preview = NS.getPreviewElement();
      if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe'){
        // strip scripts (minimal sanitization)
        const srcdoc = String(html).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
        try { preview.srcdoc = srcdoc; } catch(e){ NS.showToast('Unable to set iframe srcdoc', 'error'); }
      } else {
        try { const container = NS.$('#preview'); if(container) container.innerHTML = html; } catch(e){}
      }
      // create parsed doc fallback
      try { window._PARSER_DOC = (new DOMParser()).parseFromString(html,'text/html'); } catch(e){}
      setTimeout(()=>{ NS.attachHandlersToPreview(); NS.extractAllLocators(); }, 350);
      NS.showToast('Preview rendered', 'success');
    } catch(e){ console.error(e); NS.showToast('Render failed', 'error'); }
  }

  function clearAll(){
    try {
      const paste = NS.$('#pasteBox'); if(paste) paste.value = '';
      const preview = NS.getPreviewElement();
      if(preview && preview.tagName && preview.tagName.toLowerCase()==='iframe'){
        try { preview.srcdoc = '<body style="font-family:sans-serif"><h3>Preview cleared</h3></body>'; } catch(e){}
      } else { const container = NS.$('#preview'); if(container) container.innerHTML = ''; }
      NS.CURRENT_HTML = ''; NS.CURRENT_LOCATORS = []; NS.CUSTOM_LIST = [];
      const loc = NS.$('#locList'); if(loc) loc.innerHTML = '';
      const out = NS.$('#output'); if(out) out.value = '';
      NS.showToast('Cleared', 'info');
    } catch(e){ console.warn(e); }
  }

  // wire UI buttons if present
  NS.$('#btnRender')?.addEventListener('click', renderPreviewFromPaste);
  NS.$('#btnClear')?.addEventListener('click', clearAll);
  // attach on startup
  setTimeout(()=>{ NS.attachHandlersToPreview(); }, 600);
})();

console.info('AdhyPatch custom-ready. Version:', NS.version);
</script>















<script>
/* =========================
   Adhyan Offline — full merged script with Custom tab (complete)
   ========================= */
window.AdhyPatch = window.AdhyPatch || {};
const NS = window.AdhyPatch;

// -------------------- Phase 1: Global state --------------------
NS.version = 'adhy-merged-3.0';
NS.CURRENT_DOC = null;
NS.CURRENT_HTML = '';
NS.CURRENT_LOCATORS = [];
NS.CURRENT_CUSTOM = null;
NS.POM_CACHE = { pom:'', steps:'' };

// -------------------- Phase 2: Utilities --------------------
(function(){
  NS.$ = (s, root=document) => { try { return (root||document).querySelector(s); } catch(e){ return null; } };
  NS.$$ = (s, root=document) => { try { return Array.from((root||document).querySelectorAll(s)); } catch(e){ return []; } };

  NS.showToast = function(msg, type='info'){
    let t = document.getElementById('__adhy_toast');
    if(!t){
      t = document.createElement('div');
      t.id = '__adhy_toast';
      t.style.cssText = 'position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:#111;color:#fff;z-index:2147483647;font-family:sans-serif;opacity:1;transition:.2s';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.background = (type==='error')? '#b91c1c' : (type==='success')? '#047857' : '#111';
    t.style.opacity = '1';
    clearTimeout(t._t);
    t._t = setTimeout(()=>t.style.opacity='0',1600);
  };

  NS.copyToClipboard = async function(txt){
    try { await navigator.clipboard.writeText(txt); NS.showToast('Copied','success'); return true; }
    catch(e){
      try {
        const ta = document.createElement('textarea');
        ta.value = txt; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select(); document.execCommand && document.execCommand('copy'); ta.remove();
        NS.showToast('Copied (fallback)','success'); return true;
      } catch(err){ NS.showToast('Copy failed','error'); return false; }
    }
  };

  NS.escapeHtml = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  NS.xpathLiteral = s => `"${String(s||'').replace(/"/g,'\\"')}"`;
  NS.cssSelectorFor = el => {
    if(!el||!el.tagName) return '';
    if(el.id) return '#'+el.id;
    let sel = el.tagName.toLowerCase();
    try {
      if(el.classList && el.classList.length) sel += '.'+Array.from(el.classList).slice(0,2).map(c=>c.replace(/\s+/g,'')).join('.');
      const nm = el.getAttribute && el.getAttribute('name');
      if(nm) sel += `[name="${nm}"]`;
    } catch(e){}
    return sel;
  };
})();

// -------------------- Phase 3: Preview helpers --------------------
(function(){
  function getPreview(){ return document.getElementById('preview'); }
  function getDoc(){
    const f = getPreview();
    if(f && f.tagName && f.tagName.toLowerCase()==='iframe'){
      try {
        if(f.contentDocument) return f.contentDocument;
        // on some browsers srcdoc not available as contentDocument until load -> fallback to parsed DOM
      } catch(e){}
      if(window._PARSER_DOC) return window._PARSER_DOC;
      return document;
    }
    return window._PARSER_DOC || document;
  }
  NS.getPreviewDocument = getDoc;
})();

// -------------------- Phase 4: Highlight --------------------
(function(){
  function evalXPath(doc, xp){ try { return doc.evaluate(xp, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue; }catch(e){return null;} }
  NS.tryHighlightByXPath = function(xp){
    if(!xp) return false;
    // try preview doc first
    try {
      const doc = NS.getPreviewDocument();
      const el = evalXPath(doc, xp);
      if(el){
        const prev = el.style.outline;
        el.style.outline='3px solid #7c5cff';
        try { el.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){}
        setTimeout(()=>{ try{ el.style.outline = prev; }catch(e){} }, 1500);
        return true;
      }
    } catch(e){}
    // fallback: try top document
    try {
      const el2 = evalXPath(document, xp);
      if(el2){ const prev = el2.style.outline; el2.style.outline='3px solid #7c5cff'; setTimeout(()=>el2.style.outline=prev,1500); return true; }
    } catch(e){}
    return false;
  };
})();

// -------------------- Phase 5: Locator generators --------------------
(function(){
  function safeAttr(el,n){ try{return el.getAttribute(n);}catch(e){return null;} }
  function getLabel(el){
    try {
      if(!el) return '';
      const txt = (el.innerText || el.textContent || '').trim();
      if(txt) return txt.slice(0,120);
      const ph = safeAttr(el,'placeholder'); if(ph) return ph;
      const alt = safeAttr(el,'alt'); if(alt) return alt;
      return '';
    } catch(e){ return ''; }
  }

  NS.genBasicXPath = el=>{
    if(!el) return '';
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const tag = el.tagName.toLowerCase();
    const label = getLabel(el);
    if(label) return `//${tag}[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    // short positional fallback
    let cur = el; const parts = []; let depth=0;
    while(cur && cur.nodeType===1 && depth<8){
      const t = cur.tagName.toLowerCase();
      let ix = 1; let sib = cur.previousElementSibling;
      while(sib){ if(sib.tagName === cur.tagName) ix++; sib = sib.previousElementSibling; }
      parts.unshift(ix>1? `${t}[${ix}]` : t);
      cur = cur.parentElement; depth++;
    }
    return '//' + parts.join('/');
  };

  NS.genWildcardXPath = el=>{
    if(!el) return '';
    const label = getLabel(el);
    if(label) return `//*[contains(normalize-space(.), ${NS.xpathLiteral(label)})]`;
    const cls = (safeAttr(el,'class')||'').split(/\s+/).filter(Boolean)[0];
    if(cls) return `//*[contains(concat(' ', normalize-space(@class), ' '), ${NS.xpathLiteral(' '+cls+' ')})]`;
    return NS.genBasicXPath(el);
  };

  NS.genAxesXPath = el=>{
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    const id = el.id;
    if(id) return `//label[@for=${NS.xpathLiteral(id)}]/following::${tag}[1]`;
    const label = getLabel(el);
    if(label) return `//label[contains(normalize-space(.), ${NS.xpathLiteral(label)})]/following::${tag}[1]`;
    return NS.genBasicXPath(el);
  };

  NS.genFunctionXPath = el=>{
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    const ph = safeAttr(el,'placeholder'); if(ph) return `//${tag}[contains(@placeholder, ${NS.xpathLiteral(ph)})]`;
    const ti = safeAttr(el,'title'); if(ti) return `//${tag}[contains(@title, ${NS.xpathLiteral(ti)})]`;
    const aria = safeAttr(el,'aria-label'); if(aria) return `//${tag}[@aria-label=${NS.xpathLiteral(aria)}]`;
    return NS.genBasicXPath(el);
  };

  NS.genSalesforceXPath = el=>{
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if(safeAttr(el,'data-qa-locator')) return `//${tag}[@data-qa-locator=${NS.xpathLiteral(safeAttr(el,'data-qa-locator'))}]`;
    if(safeAttr(el,'data-id')) return `//${tag}[@data-id=${NS.xpathLiteral(safeAttr(el,'data-id'))}]`;
    return '';
  };

  NS.genPegaXPath = el=>{
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if(safeAttr(el,'data-test-id')) return `//${tag}[@data-test-id=${NS.xpathLiteral(safeAttr(el,'data-test-id'))}]`;
    if(safeAttr(el,'data-ctl')) return `//${tag}[@data-ctl=${NS.xpathLiteral(safeAttr(el,'data-ctl'))}]`;
    return '';
  };

  NS.generateLocatorsForElement = function(el){
    if(!el) return null;
    return {
      tag: el.tagName.toLowerCase(),
      text: getLabel(el) || '',
      xpaths:{
        basic: NS.genBasicXPath(el),
        wildcards: NS.genWildcardXPath(el),
        axes: NS.genAxesXPath(el),
        functions: NS.genFunctionXPath(el),
        salesforce: NS.genSalesforceXPath(el),
        pega: NS.genPegaXPath(el)
      },
      css: NS.cssSelectorFor(el)
    };
  };
})();

// -------------------- Phase 6: Extract all locators --------------------
(function(){
  function collect(doc){
    try {
      return Array.from(doc.querySelectorAll('input:not([type=hidden]),button,a,select,textarea,[role=button],[data-qa-locator],[data-test-id]'));
    } catch(e){ return []; }
  }
  NS.extractAllLocators = function(){
    const doc = NS.getPreviewDocument();
    const elems = collect(doc);
    NS.CURRENT_LOCATORS = elems.map(el => NS.generateLocatorsForElement(el)).filter(Boolean);
    // preserve existing custom if any (do not overwrite)
    const activeChip = NS.$('.chip.active')?.dataset?.paneltab || 'basic';
    if(activeChip === 'custom' && NS.CURRENT_CUSTOM){
      NS.showCustomLocators(NS.CURRENT_CUSTOM);
    } else {
      NS.fillLocatorList(activeChip);
    }
    NS.showToast(`Extracted ${NS.CURRENT_LOCATORS.length}`);
    return NS.CURRENT_LOCATORS;
  };
})();

// -------------------- Phase 7: Locator List UI --------------------
(function(){
  function pickVal(loc,p){ return (loc && loc.xpaths && loc.xpaths[p]) || loc.css || ''; }
  NS.fillLocatorList = function(panel='basic'){
    panel = panel || 'basic';
    const box = NS.$('#locList');
    if(!box) return;
    box.innerHTML = '';
    const list = NS.CURRENT_LOCATORS || [];
    if(!list.length){ box.innerHTML = '<div class="small">No locators. Paste/Render to populate.</div>'; return; }
    list.forEach((loc, i)=>{
      const val = pickVal(loc,panel) || '';
      const row = document.createElement('div'); row.className='loc-row';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
      const badge = document.createElement('span'); badge.className='badge'; badge.textContent = loc.tag || 'el';
      const txt = document.createElement('div'); txt.style.minWidth='0'; txt.innerHTML = `<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${NS.escapeHtml(loc.text||'(no text)')}</div><div class="small" style="color:#6b7280">${NS.escapeHtml(loc.css||'')}</div>`;
      left.appendChild(badge); left.appendChild(txt);

      const mid = document.createElement('div'); mid.className='mono'; mid.style.flex='1'; mid.style.whiteSpace='nowrap'; mid.style.overflow='hidden'; mid.style.textOverflow='ellipsis'; mid.textContent = val;
      const act = document.createElement('div'); act.style.display='flex'; act.style.gap='6px';
      const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='Copy';
      const hiBtn = document.createElement('button'); hiBtn.className='btn'; hiBtn.textContent='Highlight';
      act.appendChild(copyBtn); act.appendChild(hiBtn);

      row.appendChild(left); row.appendChild(mid); row.appendChild(act);

      // row click: copy + highlight
      row.addEventListener('click', async (e)=>{
        if(e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT')) return;
        const v = mid.textContent || '';
        if(!v) return NS.showToast('No locator','error');
        NS.tryHighlightByXPath(v);
        await NS.copyToClipboard(v);
        NS.showToast('Copied & highlighted');
      });

      copyBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); const v = mid.textContent || ''; if(v) await NS.copyToClipboard(v); });
      hiBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const v = mid.textContent || ''; if(v) NS.tryHighlightByXPath(v); });

      box.appendChild(row);
    });
  };

  // wire chip clicks
  (function wireChips(){
    const tabs = NS.$('#locatorTabs');
    if(!tabs) return;
    tabs.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      // toggle active
      NS.$$('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      const panel = chip.dataset.paneltab || 'basic';
      if(panel === 'custom'){
        if(NS.CURRENT_CUSTOM) NS.showCustomLocators(NS.CURRENT_CUSTOM);
        else { NS.$('#locList').innerHTML = '<div class="small">Click an element in preview to populate Custom</div>'; }
      } else {
        NS.fillLocatorList(panel);
      }
    });
  })();
})();

// -------------------- Phase 8: Interactive preview click → Custom --------------------
(function(){
  function onPreviewClick(e){
    try {
      e.preventDefault && e.preventDefault();
      e.stopPropagation && e.stopPropagation();
      const el = e.target;
      if(!el) return;
      const loc = NS.generateLocatorsForElement(el);
      if(!loc) return;
      NS.CURRENT_CUSTOM = loc;
      // switch to custom tab visually
      const customChip = NS.$('.chip[data-paneltab="custom"]');
      if(customChip){ NS.$$('.chip').forEach(c=>c.classList.remove('active')); customChip.classList.add('active'); }
      NS.showCustomLocators(loc);
      // append snippet to output
      const out = NS.$('#output');
      if(out){
        const snippet = [
          `// Captured: ${loc.tag} ${loc.text?(' - '+loc.text):''}`,
          `// XPATH (basic): ${loc.xpaths.basic}`,
          `// XPATH (wildcards): ${loc.xpaths.wildcards}`,
          `// CSS: ${loc.css}`
        ].join('\n');
        out.value = (out.value ? out.value + '\n\n' : '') + snippet;
      }
      NS.showToast('Captured element to Custom', 'success');
    } catch(err){ console.warn('preview click fail', err); }
  }

  NS.attachHandlersToPreview = function(){
    try {
      // detach any previous handlers saved by attachPreviewHandler mechanism
      try { NS.detachAllPreviewHandlers && NS.detachAllPreviewHandlers(); } catch(e){}
      const iframe = NS.$('#preview');
      if(iframe && iframe.tagName && iframe.tagName.toLowerCase()==='iframe'){
        // attach after load (safe guarded)
        function attachToDoc(doc){
          if(!doc) return;
          try { doc.addEventListener('click', onPreviewClick, true); NS.attachPreviewHandler && NS.attachPreviewHandler(doc, 'click', onPreviewClick); } catch(e){ console.warn('attachToDoc failed', e); }
        }
        try {
          if(iframe.contentDocument && (iframe.contentDocument.readyState === 'complete' || iframe.contentDocument.readyState === 'interactive')){
            attachToDoc(iframe.contentDocument);
          } else {
            iframe.addEventListener('load', ()=>{ try{ attachToDoc(iframe.contentDocument); }catch(e){} }, {once:true});
          }
        } catch(e){
          // cross-origin -> fallback: parse DOM has no clickable live elements; we still support parsed DOM via _PARSER_DOC
          if(window._PARSER_DOC) try { attachToDoc(window._PARSER_DOC); } catch(e){}
        }
      } else {
        // preview not iframe — attach to parsed doc or top
        try { const doc = NS.getPreviewDocument(); doc.addEventListener('click', onPreviewClick, true); NS.attachPreviewHandler && NS.attachPreviewHandler(doc, 'click', onPreviewClick); } catch(e){}
      }
    } catch(e){ console.warn('attachHandlersToPreview error', e); }
  };

  NS.showCustomLocators = function(loc){
    const box = NS.$('#locList');
    if(!box) return;
    box.innerHTML = '';
    const strategies = ['basic','wildcards','axes','functions','salesforce','pega'];
    strategies.forEach(k=>{
      const v = (loc.xpaths && loc.xpaths[k]) || '';
      const row = document.createElement('div'); row.className='loc-row';
      row.innerHTML = `<div style="width:120px;font-weight:700">${NS.escapeHtml(k.toUpperCase())}</div><div class="mono" style="flex:1">${NS.escapeHtml(v||'(none)')}</div><div style="margin-left:8px"><button class="btn">Copy</button> <button class="btn">Highlight</button></div>`;
      const copyBtn = row.querySelector('.btn');
      // copy first button, highlight second (wired simple)
      row.querySelectorAll('.btn')[0].addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(v) await NS.copyToClipboard(v); });
      row.querySelectorAll('.btn')[1].addEventListener('click', (ev)=>{ ev.stopPropagation(); if(v) NS.tryHighlightByXPath(v); });
      row.addEventListener('click', ()=>{ if(v) { NS.tryHighlightByXPath(v); NS.copyToClipboard(v); } });
      box.appendChild(row);
    });
    // CSS row
    const cssRow = document.createElement('div'); cssRow.className='loc-row';
    cssRow.innerHTML = `<div style="width:120px;font-weight:700">CSS</div><div class="mono" style="flex:1">${NS.escapeHtml(loc.css||'(none)')}</div><div style="margin-left:8px"><button class="btn">Copy</button></div>`;
    cssRow.querySelector('.btn').addEventListener('click', async ()=>{ await NS.copyToClipboard(loc.css||''); });
    box.appendChild(cssRow);
  };
})();

// -------------------- Phase 9: Render, Clear, File open, UI wiring --------------------
(function(){
  NS.renderPreview = function(){
    try {
      const txt = (NS.$('#pasteBox') && NS.$('#pasteBox').value) || '';
      NS.CURRENT_HTML = txt;
      const iframe = NS.$('#preview');
      const clean = txt.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
      if(iframe && iframe.tagName && iframe.tagName.toLowerCase()==='iframe'){
        try { iframe.srcdoc = clean; } catch(e){ iframe.setAttribute('srcdoc', clean); }
      }
      try { window._PARSER_DOC = (new DOMParser()).parseFromString(txt, 'text/html'); } catch(e){}
      setTimeout(()=>{ try { NS.attachHandlersToPreview(); NS.extractAllLocators(); } catch(e){} }, 300);
      NS.showToast('Preview rendered','success');
    } catch(e){ console.error(e); NS.showToast('Render failed','error'); }
  };

  NS.clearAll = function(){
    try {
      const paste = NS.$('#pasteBox'); if(paste) paste.value = '';
      const iframe = NS.$('#preview'); if(iframe && iframe.tagName && iframe.tagName.toLowerCase()==='iframe') iframe.srcdoc = '<body><h3>Cleared</h3></body>';
      NS.CURRENT_HTML = ''; NS.CURRENT_DOC = null; NS.CURRENT_LOCATORS = []; NS.CURRENT_CUSTOM = null;
      NS.$('#locList') && (NS.$('#locList').innerHTML = '');
      NS.$('#output') && (NS.$('#output').value = '');
      NS.showToast('Cleared','info');
    } catch(e){ console.warn(e); }
  };

  // wire buttons
  NS.$('#btnRender')?.addEventListener('click', NS.renderPreview);
  NS.$('#btnClear')?.addEventListener('click', NS.clearAll);

  // file open wiring
  NS.$('#btnOpenFile')?.addEventListener('click', ()=> NS.$('#hiddenFile')?.click());
  NS.$('#hiddenFile')?.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = e => { NS.$('#pasteBox') && (NS.$('#pasteBox').value = e.target.result); NS.renderPreview(); };
    reader.readAsText(f);
  });

  // dropzone support
  const dz = NS.$('#dropZone');
  if(dz){
    dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.opacity = '0.8'; });
    dz.addEventListener('dragleave', (e)=>{ dz.style.opacity = '1'; });
    dz.addEventListener('drop', (e)=>{ e.preventDefault(); dz.style.opacity = '1'; const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]); if(f){ const r = new FileReader(); r.onload = ev => { NS.$('#pasteBox').value = ev.target.result; NS.renderPreview(); }; r.readAsText(f); } });
  }

  // mode chips (POM/API) — match your left card IDs
  const modePOM = NS.$('#modePOM'), modeAPI = NS.$('#modeAPI');
  if(modePOM && modeAPI){
    modePOM.addEventListener('click', ()=>{ modePOM.classList.add('active'); modeAPI.classList.remove('active'); NS.$('#pomLeftCard')?.classList.remove('hidden'); NS.$('#apiLeftCard')?.classList.add('hidden'); });
    modeAPI.addEventListener('click', ()=>{ modeAPI.classList.add('active'); modePOM.classList.remove('active'); NS.$('#apiLeftCard')?.classList.remove('hidden'); NS.$('#pomLeftCard')?.classList.add('hidden'); });
  }

  // wire .sw toggles (framework/language/runner)
  (function wireSwGroups(){
    const sws = document.querySelectorAll('.sw');
    sws.forEach(sw=>{
      sw.addEventListener('click', ()=>{
        const data = Array.from(sw.attributes).find(a=>/^data-/.test(a.name));
        if(!data) return;
        const attrName = data.name;
        document.querySelectorAll(`.sw[${attrName}]`).forEach(g=>g.classList.remove('active'));
        sw.classList.add('active');
      });
    });
  })();

  // ensure Download Output button
  (function ensureDownloadOutputButton(){
    const out = NS.$('#output');
    if(!out) return;
    if(NS.$('#btnDownloadOutput')) return;
    const btn = document.createElement('button'); btn.id='btnDownloadOutput'; btn.className='btn'; btn.textContent='Download Output';
    out.parentNode.insertBefore(btn, out.nextSibling);
    btn.addEventListener('click', ()=>{
      const txt = out.value || '';
      if(!txt) return NS.showToast('Nothing to download','error');
      const blob = new Blob([txt], {type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'adhy-output.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      NS.showToast('Download started','success');
    });
  })();

  // POM preview generation (preview-only)
  NS.$('#btnGenPOM')?.addEventListener('click', ()=>{
    try {
      const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
      const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
      // choose source locators: custom (if present) else all current
      const locs = NS.CURRENT_CUSTOM ? [NS.CURRENT_CUSTOM] : (NS.CURRENT_LOCATORS || []);
      const normalized = locs.map((l,i)=> {
        const name = (l.text || l.tag || `elem${i+1}`).toString().replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40);
        const xpath = (l.xpaths && (l.xpaths.basic || l.xpaths.wildcards)) || l.css || '';
        return { name: name || `elem${i+1}`, xpath };
      });
      // build simple preview text
      let outTxt = `// Framework: ${fw}  Language: ${lang}\n\n`;
      normalized.forEach(n=>{
        outTxt += `@FindBy(xpath = "${n.xpath.replace(/"/g,'\\"')}")\nprivate WebElement ${n.name};\n\n`;
      });
      NS.$('#output') && (NS.$('#output').value = outTxt);
      NS.showToast('POM preview generated','success');
    } catch(e){ console.error(e); NS.showToast('POM generate failed','error'); }
  });

  // Zip download optional: btnZipAll uses JSZip if present (kept explicit)
  NS.$('#btnZipAll')?.addEventListener('click', async ()=>{
    if(!window.JSZip){ NS.showToast('JSZip required','error'); return; }
    try {
      const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
      const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
      const locs = NS.CURRENT_CUSTOM ? [NS.CURRENT_CUSTOM] : (NS.CURRENT_LOCATORS || []);
      const normalized = locs.map((l,i)=> {
        const name = (l.text || l.tag || `elem${i+1}`).toString().replace(/\s+/g,'_').replace(/[^A-Za-z0-9_]/g,'').slice(0,40);
        const xpath = (l.xpaths && (l.xpaths.basic || l.xpaths.wildcards)) || l.css || '';
        return { name: name || `elem${i+1}`, xpath };
      });
      const jszip = new JSZip();
      const content = normalized.map(n=>`${n.name}: ${n.xpath}`).join('\n');
      jszip.file('locators.txt', content);
      const blob = await jszip.generateAsync({type:'blob'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `adhy-artifacts-${fw}-${lang}.zip`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
      NS.showToast('ZIP downloaded','success');
    } catch(e){ console.error(e); NS.showToast('ZIP failed','error'); }
  });

  // initial attach after load
  setTimeout(()=>{ try { NS.attachHandlersToPreview && NS.attachHandlersToPreview(); } catch(e){} }, 600);
})();

// -------------------- Phase 10: Startup --------------------
(function(){
  try { NS.fillLocatorList && NS.fillLocatorList('basic'); } catch(e){}
  console.info('AdhyPatch loaded. Version:', NS.version);
})();
</script>
















try { await navigator.clipboard.writeText(txt); NS.showToast('Copied','success'); return true; }
    catch(e){ console.warn(e); return false; }
  };

  NS.escapeHtml = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
  NS.xpathLiteral = s => `"${String(s||'').replace(/"/g,'\\"')}"`;
  NS.cssSelectorFor = el => {
    if(!el||!el.tagName) return '';
    if(el.id) return '#'+el.id;
    let sel = el.tagName.toLowerCase();
    if(el.classList && el.classList.length) sel += '.'+Array.from(el.classList).slice(0,2).join('.');
    return sel;
  };
})();

// -------------------- Phase 3: Preview helpers --------------------
(function(){
  function getPreview(){ return document.getElementById('preview'); }
  function getDoc(){
    const f = getPreview();
    if(f && f.contentDocument) return f.contentDocument;
    return window._PARSER_DOC || document;
  }
  NS.getPreviewDocument = getDoc;
})();

// -------------------- Phase 4: Highlight --------------------
(function(){
  function evalXPath(doc, xp){ try { return doc.evaluate(xp, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue; }catch(e){return null;} }
  NS.tryHighlightByXPath = function(xp){
    const doc = NS.getPreviewDocument();
    const el = evalXPath(doc, xp);
    if(!el) return false;
    const old = el.style.outline;
    el.style.outline='3px solid #7c5cff'; el.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=>el.style.outline=old,1500);
    return true;
  };
})();

// -------------------- Phase 5: Locator generators --------------------
(function(){
  function safeAttr(el,n){ try{return el.getAttribute(n);}catch(e){return null;} }
  function getLabel(el){ return (el.innerText||el.textContent||'').trim().slice(0,80); }

  NS.genBasicXPath = el=>{
    if(!el) return '';
    if(el.id) return `//*[@id=${NS.xpathLiteral(el.id)}]`;
    const tag = el.tagName.toLowerCase();
    return `//${tag}[contains(normalize-space(.),${NS.xpathLiteral(getLabel(el))})]`;
  };
  NS.genWildcardXPath = el=>`//*[contains(normalize-space(.),${NS.xpathLiteral(getLabel(el))})]`;
  NS.genAxesXPath = el=>`//label[contains(.,${NS.xpathLiteral(getLabel(el))})]/following::${el.tagName.toLowerCase()}[1]`;
  NS.genFunctionXPath = el=>`//${el.tagName.toLowerCase()}[starts-with(@placeholder,'${(safeAttr(el,'placeholder')||'').split(' ')[0]}')]`;
  NS.genSalesforceXPath = el=>safeAttr(el,'data-id')?`//${el.tagName.toLowerCase()}[@data-id=${NS.xpathLiteral(safeAttr(el,'data-id'))}]`:'';
  NS.genPegaXPath = el=>safeAttr(el,'data-ctl')?`//${el.tagName.toLowerCase()}[@data-ctl=${NS.xpathLiteral(safeAttr(el,'data-ctl'))}]`:'';

  NS.generateLocatorsForElement = el=>{
    return {
      tag: el.tagName.toLowerCase(),
      text: getLabel(el),
      xpaths:{
        basic:NS.genBasicXPath(el),
        wildcards:NS.genWildcardXPath(el),
        axes:NS.genAxesXPath(el),
        functions:NS.genFunctionXPath(el),
        salesforce:NS.genSalesforceXPath(el),
        pega:NS.genPegaXPath(el)
      },
      css:NS.cssSelectorFor(el)
    };
  };
})();

// -------------------- Phase 6: Extract all locators --------------------
(function(){
  function collect(doc){
    return Array.from(doc.querySelectorAll('input,button,select,textarea,a,[role=button]'));
  }
  NS.extractAllLocators = function(){
    const doc = NS.getPreviewDocument();
    NS.CURRENT_LOCATORS = collect(doc).map(NS.generateLocatorsForElement);
    NS.fillLocatorList('basic');
    NS.showToast(`Extracted ${NS.CURRENT_LOCATORS.length}`);
  };
})();

// -------------------- Phase 7: Locator List UI --------------------
(function(){
  function pickVal(loc,p){ return loc.xpaths[p]||loc.css||''; }
  NS.fillLocatorList = function(panel='basic'){
    const box=NS.$('#locList'); box.innerHTML='';
    (NS.CURRENT_LOCATORS||[]).forEach(loc=>{
      const val=pickVal(loc,panel);
      const row=document.createElement('div'); row.className='loc-row';
      row.innerHTML=`<div class="mono">${NS.escapeHtml(val)}</div>`;
      row.addEventListener('click',()=>{NS.copyToClipboard(val);NS.tryHighlightByXPath(val);});
      box.appendChild(row);
    });
  };
})();

// -------------------- Phase 8: Interactive click → Custom --------------------
(function(){
  function onClick(e){
    e.preventDefault(); e.stopPropagation();
    const el=e.target; if(!el) return;
    NS.CURRENT_CUSTOM=NS.generateLocatorsForElement(el);
    NS.showCustomLocators(NS.CURRENT_CUSTOM);
  }
  NS.attachHandlersToPreview=function(){
    const doc=NS.getPreviewDocument();
    doc.addEventListener('click',onClick,true);
  };

  NS.showCustomLocators=function(loc){
    const box=NS.$('#locList'); box.innerHTML='';
    const strategies=['basic','wildcards','axes','functions','salesforce','pega'];
    strategies.forEach(k=>{
      const v=loc.xpaths[k];
      const row=document.createElement('div'); row.className='loc-row';
      row.innerHTML=`<b>${k}</b> <span class="mono">${NS.escapeHtml(v)}</span>`;
      row.addEventListener('click',()=>{NS.copyToClipboard(v);NS.tryHighlightByXPath(v);});
      box.appendChild(row);
    });
    const cssRow=document.createElement('div'); cssRow.className='loc-row';
    cssRow.innerHTML=`<b>CSS</b> <span class="mono">${loc.css}</span>`;
    box.appendChild(cssRow);
  };
})();

// -------------------- Phase 9: Render & Clear --------------------
(function(){
  NS.renderPreview=function(){
    const txt=NS.$('#pasteBox').value||'<body><h3>No input</h3>';
    NS.CURRENT_HTML=txt;
    const f=NS.$('#preview'); f.srcdoc=txt.replace(/<script[\s\S]*?<\/script>/gi,'');
    setTimeout(()=>{NS.attachHandlersToPreview();NS.extractAllLocators();},300);
  };
  NS.clearAll=function(){
    NS.$('#pasteBox').value=''; NS.$('#preview').srcdoc='<body><h3>Cleared</h3>';
    NS.CURRENT_LOCATORS=[]; NS.$('#locList').innerHTML=''; NS.$('#output').value='';
  };
  NS.$('#btnRender')?.addEventListener('click',NS
